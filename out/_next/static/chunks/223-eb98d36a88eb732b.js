"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[223],{6223:(e,t,i)=>{var r,n,s;i.d(t,{A:()=>rO});let o=["a","b","c","d","e","f","g","h"],a=["1","2","3","4","5","6","7","8"],l=["white","black"],h=["pawn","knight","bishop","rook","queen","king"],c=["a","h"],u=e=>"role"in e,d=e=>void 0!==e,p=e=>"white"===e?"black":"white",f=e=>e>>3,m=e=>7&e,g=e=>{switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function v(e){switch(e.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function b(e){if(2!==e.length)return;let t=e.charCodeAt(0)-97,i=e.charCodeAt(1)-49;if(!(t<0)&&!(t>=8)&&!(i<0)&&!(i>=8))return t+8*i}let k=e=>o[m(e)]+a[f(e)],w=e=>u(e)?`${g(e.role).toUpperCase()}@${k(e.to)}`:k(e.from)+k(e.to)+(e.promotion?g(e.promotion):""),y=(e,t)=>"white"===e?"a"===t?2:6:"a"===t?58:62,C=(e,t)=>"white"===e?"a"===t?3:5:"a"===t?59:61,x=e=>S[e],S={flipTheBoard:"Flip the board",analysisBoard:"Analysis board",practiceWithComputer:"Practice with computer",getPgn:"Get PGN",download:"Download",viewOnLichess:"View on Lichess",viewOnSite:"View on site"},E=["white","black"],_=["a","b","c","d","e","f","g","h"],M=["1","2","3","4","5","6","7","8"],q=[...M].reverse(),O=Array.prototype.concat(..._.map(e=>M.map(t=>e+t))),A=e=>O[8*e[0]+e[1]],P=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],R=e=>{if(e)return"@"===e[1]?[e.slice(2,4)]:[e.slice(0,2),e.slice(2,4)]},N=O.map(P),B=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;let t=performance.now()-e;return e=void 0,t}}},T=e=>"white"===e?"black":"white",L=(e,t)=>{let i=e[0]-t[0],r=e[1]-t[1];return i*i+r*r},z=(e,t)=>e.role===t.role&&e.color===t.color,K=e=>(t,i)=>[(i?t[0]:7-t[0])*e.width/8,(i?7-t[1]:t[1])*e.height/8],$=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},D=(e,t,i=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${i})`},I=(e,t)=>{e.style.visibility=t?"visible":"hidden"},U=e=>{var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},F=e=>2===e.button,W=(e,t)=>{let i=document.createElement(e);return t&&(i.className=t),i};function G(e,t,i){let r=P(e);return t||(r[0]=7-r[0],r[1]=7-r[1]),[i.left+i.width*r[0]/8+i.width/16,i.top+i.height*(7-r[1])/8+i.height/16]}class H{constructor(e){this.path=e,this.size=()=>this.path.length/2,this.head=()=>this.path.slice(0,2),this.tail=()=>new H(this.path.slice(2)),this.init=()=>new H(this.path.slice(0,-2)),this.last=()=>this.path.slice(-2),this.empty=()=>""==this.path,this.contains=e=>this.path.startsWith(e.path),this.isChildOf=e=>this.init()===e,this.append=e=>new H(this.path+e),this.equals=e=>this.path==e.path}}H.root=new H("");class j{constructor(e,t,i,r){this.initial=e,this.moves=t,this.players=i,this.metadata=r,this.nodeAt=e=>Q(this.moves,e),this.dataAt=e=>{let t=this.nodeAt(e);return t?Y(t)?t.data:this.initial:void 0},this.title=()=>this.players.white.name?[this.players.white.title,this.players.white.name,"vs",this.players.black.title,this.players.black.name].filter(e=>e&&!!e.trim()).join("_").replace(" ","-"):"lichess-pgn-viewer",this.pathAtMainlinePly=e=>{var t;return 0==e?H.root:(null===(t=this.mainline[Math.max(0,Math.min(this.mainline.length-1,"last"==e?9999:e-1))])||void 0===t?void 0:t.path)||H.root},this.hasPlayerName=()=>{var e,t;return!!((null===(e=this.players.white)||void 0===e?void 0:e.name)||(null===(t=this.players.black)||void 0===t?void 0:t.name))},this.mainline=Array.from(this.moves.mainline())}}let V=(e,t)=>e.children.find(e=>e.data.path.last()==t),Q=(e,t)=>{if(t.empty())return e;let i=V(e,t.head());return i?Q(i,t.tail()):void 0},Y=e=>"data"in e,Z=e=>"uci"in e,X=e=>u(e)?String.fromCharCode(35+e.to,139+["queen","rook","bishop","knight","pawn"].indexOf(e.role)):String.fromCharCode(35+e.from,e.promotion?99+8*["queen","rook","bishop","knight","king"].indexOf(e.promotion)+m(e.to):35+e.to);class J{unwrap(e,t){let i=this._chain(t=>r.ok(e?e(t):t),e=>t?r.ok(t(e)):r.err(e));if(i.isErr)throw i.error;return i.value}map(e,t){return this._chain(t=>r.ok(e(t)),e=>r.err(t?t(e):e))}chain(e,t){return this._chain(e,t||(e=>r.err(e)))}}class ee extends J{constructor(e){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=e}_chain(e,t){return e(this.value)}}class et extends J{constructor(e){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=e}_chain(e,t){return t(this.error)}}!function(e){e.ok=function(e){return new ee(e)},e.err=function(e){return new et(e||Error())},e.all=function(t){if(Array.isArray(t)){let i=[];for(let e=0;e<t.length;e++){let r=t[e];if(r.isErr)return r;i.push(r.value)}return e.ok(i)}let i={},r=Object.keys(t);for(let e=0;e<r.length;e++){let n=t[r[e]];if(n.isErr)return n;i[r[e]]=n.value}return e.ok(i)}}(r||(r={}));let ei=e=>(e-=e>>>1&0x55555555,Math.imul((e=(0x33333333&e)+(e>>>2&0x33333333))+(e>>>4)&0xf0f0f0f,0x1010101)>>24),er=e=>(e=e>>>8&0xff00ff|(0xff00ff&e)<<8)>>>16&65535|(65535&e)<<16,en=e=>er(e=(e=(e=e>>>1&0x55555555|(0x55555555&e)<<1)>>>2&0x33333333|(0x33333333&e)<<2)>>>4&0xf0f0f0f|(0xf0f0f0f&e)<<4);class es{constructor(e,t){this.lo=0|e,this.hi=0|t}static fromSquare(e){return e>=32?new es(0,1<<e-32):new es(1<<e,0)}static fromRank(e){return new es(255,0).shl64(8*e)}static fromFile(e){return new es(0x1010101<<e,0x1010101<<e)}static empty(){return new es(0,0)}static full(){return new es(0xffffffff,0xffffffff)}static corners(){return new es(129,0x81000000)}static center(){return new es(0x18000000,24)}static backranks(){return new es(255,0xff000000)}static backrank(e){return"white"===e?new es(255,0):new es(0,0xff000000)}static lightSquares(){return new es(0x55aa55aa,0x55aa55aa)}static darkSquares(){return new es(0xaa55aa55,0xaa55aa55)}complement(){return new es(~this.lo,~this.hi)}xor(e){return new es(this.lo^e.lo,this.hi^e.hi)}union(e){return new es(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new es(this.lo&e.lo,this.hi&e.hi)}diff(e){return new es(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?es.empty():e>=32?new es(this.hi>>>e-32,0):e>0?new es(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?es.empty():e>=32?new es(0,this.lo<<e-32):e>0?new es(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new es(er(this.hi),er(this.lo))}rbit64(){return new es(en(this.hi),en(this.lo))}minus64(e){let t=this.lo-e.lo,i=(t&e.lo&1)+(e.lo>>>1)+(t>>>1)>>>31;return new es(t,this.hi-(e.hi+i))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return ei(this.lo)+ei(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(e){return(e>=32?this.hi&1<<e-32:this.lo&1<<e)!=0}set(e,t){return t?this.with(e):this.without(e)}with(e){return e>=32?new es(this.lo,this.hi|1<<e-32):new es(this.lo|1<<e,this.hi)}without(e){return e>=32?new es(this.lo,this.hi&~(1<<e-32)):new es(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new es(this.lo,this.hi^1<<e-32):new es(this.lo^1<<e,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}withoutFirst(){return 0!==this.lo?new es(this.lo&this.lo-1,this.hi):new es(0,this.hi&this.hi-1)}moreThanOne(){return 0!==this.hi&&0!==this.lo||(this.lo&this.lo-1)!=0||(this.hi&this.hi-1)!=0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let e=this.lo,t=this.hi;for(;0!==e;){let t=31-Math.clz32(e&-e);e^=1<<t,yield t}for(;0!==t;){let e=31-Math.clz32(t&-t);t^=1<<e,yield 32+e}}*reversed(){let e=this.lo,t=this.hi;for(;0!==t;){let e=31-Math.clz32(t);t^=1<<e,yield 32+e}for(;0!==e;){let t=31-Math.clz32(e);e^=1<<t,yield t}}}class eo{constructor(){}static default(){let e=new eo;return e.reset(),e}reset(){this.occupied=new es(65535,0xffff0000),this.promoted=es.empty(),this.white=new es(65535,0),this.black=new es(0,0xffff0000),this.pawn=new es(65280,0xff0000),this.knight=new es(66,0x42000000),this.bishop=new es(36,0x24000000),this.rook=new es(129,0x81000000),this.queen=new es(8,0x8000000),this.king=new es(16,0x10000000)}static empty(){let e=new eo;return e.clear(),e}clear(){for(let e of(this.occupied=es.empty(),this.promoted=es.empty(),l))this[e]=es.empty();for(let e of h)this[e]=es.empty()}clone(){let e=new eo;for(let t of(e.occupied=this.occupied,e.promoted=this.promoted,l))e[t]=this[t];for(let t of h)e[t]=this[t];return e}getColor(e){return this.white.has(e)?"white":this.black.has(e)?"black":void 0}getRole(e){for(let t of h)if(this[t].has(e))return t}get(e){let t=this.getColor(e);if(t)return{color:t,role:this.getRole(e),promoted:this.promoted.has(e)}}take(e){let t=this.get(e);return t&&(this.occupied=this.occupied.without(e),this[t.color]=this[t.color].without(e),this[t.role]=this[t.role].without(e),t.promoted&&(this.promoted=this.promoted.without(e))),t}set(e,t){let i=this.take(e);return this.occupied=this.occupied.with(e),this[t.color]=this[t.color].with(e),this[t.role]=this[t.role].with(e),t.promoted&&(this.promoted=this.promoted.with(e)),i}has(e){return this.occupied.has(e)}*[Symbol.iterator](){for(let e of this.occupied)yield[e,this.get(e)]}pieces(e,t){return this[e].intersect(this[t])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(e){return this.pieces(e,"king").singleSquare()}}class ea{constructor(){}static empty(){let e=new ea;for(let t of h)e[t]=0;return e}static fromBoard(e,t){let i=new ea;for(let r of h)i[r]=e.pieces(t,r).size();return i}clone(){let e=new ea;for(let t of h)e[t]=this[t];return e}equals(e){return h.every(t=>this[t]===e[t])}add(e){let t=new ea;for(let i of h)t[i]=this[i]+e[i];return t}nonEmpty(){return h.some(e=>this[e]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class el{constructor(e,t){this.white=e,this.black=t}static empty(){return new el(ea.empty(),ea.empty())}static fromBoard(e){return new el(ea.fromBoard(e,"white"),ea.fromBoard(e,"black"))}clone(){return new el(this.white.clone(),this.black.clone())}equals(e){return this.white.equals(e.white)&&this.black.equals(e.black)}add(e){return new el(this.white.add(e.white),this.black.add(e.black))}count(e){return this.white[e]+this.black[e]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class eh{constructor(e,t){this.white=e,this.black=t}static default(){return new eh(3,3)}clone(){return new eh(this.white,this.black)}equals(e){return this.white===e.white&&this.black===e.black}}!function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"}(n||(n={}));class ec extends Error{}let eu=(e,t,i)=>{let r=e.indexOf(t);for(;i-- >0&&-1!==r;)r=e.indexOf(t,r+t.length);return r},ed=e=>/^\d{1,4}$/.test(e)?parseInt(e,10):void 0,ep=e=>{let t=v(e);return t&&{role:t,color:e.toLowerCase()===e?"black":"white"}},ef=e=>{let t=eo.empty(),i=7,s=0;for(let o=0;o<e.length;o++){let a=e[o];if("/"===a&&8===s)s=0,i--;else{let l=parseInt(a,10);if(l>0)s+=l;else{if(s>=8||i<0)return r.err(new ec(n.Board));let l=s+8*i,h=ep(a);if(!h)return r.err(new ec(n.Board));"~"===e[o+1]&&(h.promoted=!0,o++),t.set(l,h),s++}}}return 0!==i||8!==s?r.err(new ec(n.Board)):r.ok(t)},em=e=>{if(e.length>64)return r.err(new ec(n.Pockets));let t=el.empty();for(let i of e){let e=ep(i);if(!e)return r.err(new ec(n.Pockets));t[e.color][e.role]++}return r.ok(t)},eg=(e,t)=>{let i=es.empty();if("-"===t)return r.ok(i);for(let s of t){let t;let o=s.toLowerCase(),a=s===o?"black":"white",l=es.backrank(a).intersect(e[a]);if("q"===o)t=l;else if("k"===o)t=l.reversed();else{if(!("a"<=o)||!(o<="h"))return r.err(new ec(n.Castling));t=es.fromFile(o.charCodeAt(0)-97).intersect(l)}for(let r of t){if(e.king.has(r))break;if(e.rook.has(r)){i=i.with(r);break}}}return l.some(e=>es.backrank(e).intersect(i).size()>2)?r.err(new ec(n.Castling)):r.ok(i)},ev=e=>{let t=e.split("+");if(3===t.length&&""===t[0]){let e=ed(t[1]),i=ed(t[2]);return!d(e)||e>3||!d(i)||i>3?r.err(new ec(n.RemainingChecks)):r.ok(new eh(3-e,3-i))}if(2!==t.length)return r.err(new ec(n.RemainingChecks));{let e=ed(t[0]),i=ed(t[1]);return!d(e)||e>3||!d(i)||i>3?r.err(new ec(n.RemainingChecks)):r.ok(new eh(e,i))}},eb=e=>{let t,i;let s=e.split(/[\s_]+/),o=s.shift(),a=r.ok(void 0);if(o.endsWith("]")){let e=o.indexOf("[");if(-1===e)return r.err(new ec(n.Fen));t=ef(o.slice(0,e)),a=em(o.slice(e+1,-1))}else{let e=eu(o,"/",7);-1===e?t=ef(o):(t=ef(o.slice(0,e)),a=em(o.slice(e+1)))}let l=s.shift();if(d(l)&&"w"!==l){if("b"!==l)return r.err(new ec(n.Turn));i="black"}else i="white";return t.chain(e=>{let t,o;let l=s.shift(),h=d(l)?eg(e,l):r.ok(es.empty()),c=s.shift();if(d(c)&&"-"!==c&&!d(t=b(c)))return r.err(new ec(n.EpSquare));let u=s.shift();d(u)&&u.includes("+")&&(o=ev(u),u=s.shift());let p=d(u)?ed(u):0;if(!d(p))return r.err(new ec(n.Halfmoves));let f=s.shift(),m=d(f)?ed(f):1;if(!d(m))return r.err(new ec(n.Fullmoves));let g=s.shift(),v=r.ok(void 0);if(d(g)){if(d(o))return r.err(new ec(n.RemainingChecks));v=ev(g)}else d(o)&&(v=o);return s.length>0?r.err(new ec(n.Fen)):a.chain(r=>h.chain(n=>v.map(s=>({board:e,pockets:r,turn:i,unmovedRooks:n,remainingChecks:s,epSquare:t,halfmoves:p,fullmoves:Math.max(1,m)}))))})},ek=e=>{let t=g(e.role);return"white"===e.color&&(t=t.toUpperCase()),e.promoted&&(t+="~"),t},ew=e=>{let t="",i=0;for(let r=7;r>=0;r--)for(let n=0;n<8;n++){let s=n+8*r,o=e.get(s);o?(i>0&&(t+=i,i=0),t+=ek(o)):i++,7===n&&(i>0&&(t+=i,i=0),0!==r&&(t+="/"))}return t},ey=e=>h.map(t=>g(t).repeat(e[t])).join(""),eC=e=>ey(e.white).toUpperCase()+ey(e.black),ex=(e,t)=>{let i="";for(let r of l){let n=es.backrank(r),s=e.kingOf(r);d(s)&&!n.has(s)&&(s=void 0);let a=e.pieces(r,"rook").intersect(n);for(let e of t.intersect(a).reversed())if(e===a.first()&&d(s)&&e<s)i+="white"===r?"Q":"q";else if(e===a.last()&&d(s)&&s<e)i+="white"===r?"K":"k";else{let t=o[m(e)];i+="white"===r?t.toUpperCase():t}}return i||"-"},eS=e=>`${e.white}+${e.black}`,eE=(e,t)=>[ew(e.board)+(e.pockets?`[${eC(e.pockets)}]`:""),e.turn[0],ex(e.board,e.unmovedRooks),d(e.epSquare)?k(e.epSquare):"-",...e.remainingChecks?[eS(e.remainingChecks)]:[],...(null==t?void 0:t.epd)?[]:[Math.max(0,Math.min(e.halfmoves,9999)),Math.max(1,Math.min(e.fullmoves,9999))]].join(" "),e_=(e,t)=>{let i=es.empty();for(let r of t){let t=e+r;0<=t&&t<64&&2>=Math.abs(m(e)-m(t))&&(i=i.with(t))}return i},eM=e=>{let t=[];for(let i=0;i<64;i++)t[i]=e(i);return t},eq=eM(e=>e_(e,[-9,-8,-7,-1,1,7,8,9])),eO=eM(e=>e_(e,[-17,-15,-10,-6,6,10,15,17])),eA={white:eM(e=>e_(e,[7,9])),black:eM(e=>e_(e,[-7,-9]))},eP=e=>eq[e],eR=e=>eO[e],eN=(e,t)=>eA[e][t],eB=eM(e=>es.fromFile(m(e)).without(e)),eT=eM(e=>es.fromRank(f(e)).without(e)),eL=eM(e=>{let t=new es(0x8040201,0x80402010),i=8*(f(e)-m(e));return(i>=0?t.shl64(i):t.shr64(-i)).without(e)}),ez=eM(e=>{let t=new es(0x10204080,0x1020408),i=8*(f(e)+m(e)-7);return(i>=0?t.shl64(i):t.shr64(-i)).without(e)}),eK=(e,t,i)=>{let r=i.intersect(t),n=r.bswap64();return r=r.minus64(e),n=n.minus64(e.bswap64()),r.xor(n.bswap64()).intersect(t)},e$=(e,t)=>eK(es.fromSquare(e),eB[e],t),eD=(e,t)=>{let i=eT[e],r=t.intersect(i),n=r.rbit64();return r=r.minus64(es.fromSquare(e)),n=n.minus64(es.fromSquare(63-e)),r.xor(n.rbit64()).intersect(i)},eI=(e,t)=>{let i=es.fromSquare(e);return eK(i,eL[e],t).xor(eK(i,ez[e],t))},eU=(e,t)=>e$(e,t).xor(eD(e,t)),eF=(e,t)=>eI(e,t).xor(eU(e,t)),eW=(e,t,i)=>{switch(e.role){case"pawn":return eN(e.color,t);case"knight":return eR(t);case"bishop":return eI(t,i);case"rook":return eU(t,i);case"queen":return eF(t,i);case"king":return eP(t)}},eG=(e,t)=>{let i=es.fromSquare(t);return eT[e].intersects(i)?eT[e].with(e):ez[e].intersects(i)?ez[e].with(e):eL[e].intersects(i)?eL[e].with(e):eB[e].intersects(i)?eB[e].with(e):es.empty()},eH=(e,t)=>eG(e,t).intersect(es.full().shl64(e).xor(es.full().shl64(t))).withoutFirst();!function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.ImpossibleCheck="ERR_IMPOSSIBLE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"}(s||(s={}));class ej extends Error{}let eV=(e,t,i,r)=>i[t].intersect(eU(e,r).intersect(i.rooksAndQueens()).union(eI(e,r).intersect(i.bishopsAndQueens())).union(eR(e).intersect(i.knight)).union(eP(e).intersect(i.king)).union(eN(p(t),e).intersect(i.pawn)));class eQ{constructor(){}static default(){let e=new eQ;return e.unmovedRooks=es.corners(),e.rook={white:{a:0,h:7},black:{a:56,h:63}},e.path={white:{a:new es(14,0),h:new es(96,0)},black:{a:new es(0,0xe000000),h:new es(0,0x60000000)}},e}static empty(){let e=new eQ;return e.unmovedRooks=es.empty(),e.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},e.path={white:{a:es.empty(),h:es.empty()},black:{a:es.empty(),h:es.empty()}},e}clone(){let e=new eQ;return e.unmovedRooks=this.unmovedRooks,e.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},e.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},e}add(e,t,i,r){let n=y(e,t),s=C(e,t);this.unmovedRooks=this.unmovedRooks.with(r),this.rook[e][t]=r,this.path[e][t]=eH(r,s).with(s).union(eH(i,n).with(n)).without(i).without(r)}static fromSetup(e){let t=eQ.empty(),i=e.unmovedRooks.intersect(e.board.rook);for(let r of l){let n=es.backrank(r),s=e.board.kingOf(r);if(!d(s)||!n.has(s))continue;let o=i.intersect(e.board[r]).intersect(n),a=o.first();d(a)&&a<s&&t.add(r,"a",s,a);let l=o.last();d(l)&&s<l&&t.add(r,"h",s,l)}return t}discardRook(e){if(this.unmovedRooks.has(e))for(let t of(this.unmovedRooks=this.unmovedRooks.without(e),l))for(let i of c)this.rook[t][i]===e&&(this.rook[t][i]=void 0)}discardColor(e){this.unmovedRooks=this.unmovedRooks.diff(es.backrank(e)),this.rook[e].a=void 0,this.rook[e].h=void 0}}class eY{constructor(e){this.rules=e}reset(){this.board=eo.default(),this.pockets=void 0,this.turn="white",this.castles=eQ.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(e){this.board=e.board.clone(),this.board.promoted=es.empty(),this.pockets=void 0,this.turn=e.turn,this.castles=eQ.fromSetup(e),this.epSquare=eX(this,e.epSquare),this.remainingChecks=void 0,this.halfmoves=e.halfmoves,this.fullmoves=e.fullmoves}kingAttackers(e,t,i){return eV(e,t,this.board,i)}playCaptureAt(e,t){this.halfmoves=0,"rook"===t.role&&this.castles.discardRook(e),this.pockets&&this.pockets[p(t.color)][t.promoted?"pawn":t.role]++}ctx(){let e=this.isVariantEnd(),t=this.board.kingOf(this.turn);if(!d(t))return{king:t,blockers:es.empty(),checkers:es.empty(),variantEnd:e,mustCapture:!1};let i=eU(t,es.empty()).intersect(this.board.rooksAndQueens()).union(eI(t,es.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[p(this.turn)]),r=es.empty();for(let e of i){let i=eH(t,e).intersect(this.board.occupied);i.moreThanOne()||(r=r.union(i))}let n=this.kingAttackers(t,p(this.turn),this.board.occupied);return{king:t,blockers:r,checkers:n,variantEnd:e,mustCapture:!1}}clone(){var e,t;let i=new this.constructor;return i.board=this.board.clone(),i.pockets=null===(e=this.pockets)||void 0===e?void 0:e.clone(),i.turn=this.turn,i.castles=this.castles.clone(),i.epSquare=this.epSquare,i.remainingChecks=null===(t=this.remainingChecks)||void 0===t?void 0:t.clone(),i.halfmoves=this.halfmoves,i.fullmoves=this.fullmoves,i}validate(e){if(this.board.occupied.isEmpty())return r.err(new ej(s.Empty));if(2!==this.board.king.size()||!d(this.board.kingOf(this.turn)))return r.err(new ej(s.Kings));let t=this.board.kingOf(p(this.turn));return d(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?r.err(new ej(s.OppositeCheck)):es.backranks().intersects(this.board.pawn)?r.err(new ej(s.PawnsOnBackrank)):(null==e?void 0:e.ignoreImpossibleCheck)?r.ok(void 0):this.validateCheckers():r.err(new ej(s.Kings))}validateCheckers(){let e=this.board.kingOf(this.turn);if(d(e)){let t=this.kingAttackers(e,p(this.turn),this.board.occupied);if(t.nonEmpty()){if(d(this.epSquare)){let i=8^this.epSquare,n=24^this.epSquare;if(t.moreThanOne()||t.first()!==i&&this.kingAttackers(e,p(this.turn),this.board.occupied.without(i).with(n)).nonEmpty())return r.err(new ej(s.ImpossibleCheck))}else if(t.size()>2||2===t.size()&&eG(t.first(),t.last()).has(e))return r.err(new ej(s.ImpossibleCheck))}}return r.ok(void 0)}dropDests(e){return es.empty()}dests(e,t){let i,r;if((t=t||this.ctx()).variantEnd)return es.empty();let n=this.board.get(e);if(!n||n.color!==this.turn)return es.empty();if("pawn"===n.role){i=eN(this.turn,e).intersect(this.board[p(this.turn)]);let n="white"===this.turn?8:-8,s=e+n;if(0<=s&&s<64&&!this.board.occupied.has(s)){i=i.with(s);let t="white"===this.turn?e<16:e>=48,r=s+n;t&&!this.board.occupied.has(r)&&(i=i.with(r))}if(d(this.epSquare)&&e0(this,e,t)){let e=this.epSquare-n;(t.checkers.isEmpty()||t.checkers.singleSquare()===e)&&(r=es.fromSquare(this.epSquare))}}else i="bishop"===n.role?eI(e,this.board.occupied):"knight"===n.role?eR(e):"rook"===n.role?eU(e,this.board.occupied):"queen"===n.role?eF(e,this.board.occupied):eP(e);if(i=i.diff(this.board[this.turn]),d(t.king)){if("king"===n.role){let r=this.board.occupied.without(e);for(let e of i)this.kingAttackers(e,p(this.turn),r).nonEmpty()&&(i=i.without(e));return i.union(e1(this,"a",t)).union(e1(this,"h",t))}if(t.checkers.nonEmpty()){let e=t.checkers.singleSquare();if(!d(e))return es.empty();i=i.intersect(eH(e,t.king).with(e))}t.blockers.has(e)&&(i=i.intersect(eG(e,t.king)))}return r&&(i=i.union(r)),i}isVariantEnd(){return!1}variantOutcome(e){}hasInsufficientMaterial(e){return!this.board[e].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()&&(this.board[e].intersects(this.board.knight)?2>=this.board[e].size()&&this.board[p(e)].diff(this.board.king).diff(this.board.queen).isEmpty():!this.board[e].intersects(this.board.bishop)||(!this.board.bishop.intersects(es.darkSquares())||!this.board.bishop.intersects(es.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty())}toSetup(){var e,t;return{board:this.board.clone(),pockets:null===(e=this.pockets)||void 0===e?void 0:e.clone(),turn:this.turn,unmovedRooks:this.castles.unmovedRooks,epSquare:eJ(this),remainingChecks:null===(t=this.remainingChecks)||void 0===t?void 0:t.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return l.every(e=>this.hasInsufficientMaterial(e))}hasDests(e){for(let t of(e=e||this.ctx(),this.board[this.turn]))if(this.dests(t,e).nonEmpty())return!0;return this.dropDests(e).nonEmpty()}isLegal(e,t){if(u(e))return!(!this.pockets||this.pockets[this.turn][e.role]<=0||"pawn"===e.role&&es.backranks().has(e.to))&&this.dropDests(t).has(e.to);{if("pawn"===e.promotion||"king"===e.promotion&&"antichess"!==this.rules||!!e.promotion!==(this.board.pawn.has(e.from)&&es.backranks().has(e.to)))return!1;let i=this.dests(e.from,t);return i.has(e.to)||i.has(e5(this,e).to)}}isCheck(){let e=this.board.kingOf(this.turn);return d(e)&&this.kingAttackers(e,p(this.turn),this.board.occupied).nonEmpty()}isEnd(e){return(e?!!e.variantEnd:!!this.isVariantEnd())||this.isInsufficientMaterial()||!this.hasDests(e)}isCheckmate(e){return!(e=e||this.ctx()).variantEnd&&e.checkers.nonEmpty()&&!this.hasDests(e)}isStalemate(e){return!(e=e||this.ctx()).variantEnd&&e.checkers.isEmpty()&&!this.hasDests(e)}outcome(e){return this.variantOutcome(e)||((e=e||this.ctx(),this.isCheckmate(e))?{winner:p(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(e)?{winner:void 0}:void 0)}allDests(e){e=e||this.ctx();let t=new Map;if(e.variantEnd)return t;for(let i of this.board[this.turn])t.set(i,this.dests(i,e));return t}play(e){let t=this.turn,i=this.epSquare,r=e3(this,e);if(this.epSquare=void 0,this.halfmoves+=1,"black"===t&&(this.fullmoves+=1),this.turn=p(t),u(e))this.board.set(e.to,{role:e.role,color:t}),this.pockets&&this.pockets[t][e.role]--,"pawn"===e.role&&(this.halfmoves=0);else{let n;let s=this.board.take(e.from);if(!s)return;if("pawn"===s.role)this.halfmoves=0,e.to===i&&(n=this.board.take(e.to+("white"===t?-8:8))),16===Math.abs(e.from-e.to)&&8<=e.from&&e.from<=55&&(this.epSquare=e.from+e.to>>1),e.promotion&&(s.role=e.promotion,s.promoted=!!this.pockets);else if("rook"===s.role)this.castles.discardRook(e.from);else if("king"===s.role){if(r){let e=this.castles.rook[t][r];if(d(e)){let i=this.board.take(e);this.board.set(y(t,r),s),i&&this.board.set(C(t,r),i)}}this.castles.discardColor(t)}if(!r){let t=this.board.set(e.to,s)||n;t&&this.playCaptureAt(e.to,t)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[t]=Math.max(this.remainingChecks[t]-1,0))}}class eZ extends eY{constructor(){super("chess")}static default(){let e=new this;return e.reset(),e}static fromSetup(e,t){let i=new this;return i.setupUnchecked(e),i.validate(t).map(e=>i)}clone(){return super.clone()}}let eX=(e,t)=>{if(!d(t))return;let i="white"===e.turn?5:2,r="white"===e.turn?8:-8;if(f(t)!==i||e.board.occupied.has(t+r))return;let n=t-r;if(e.board.pawn.has(n)&&e.board[p(e.turn)].has(n))return t},eJ=e=>{if(!d(e.epSquare))return;let t=e.ctx();for(let i of e.board.pieces(e.turn,"pawn").intersect(eN(p(e.turn),e.epSquare)))if(e.dests(i,t).has(e.epSquare))return e.epSquare},e0=(e,t,i)=>{if(!d(e.epSquare)||!eN(e.turn,t).has(e.epSquare))return!1;if(!d(i.king))return!0;let r=e.epSquare+("white"===e.turn?-8:8),n=e.board.occupied.toggle(t).toggle(e.epSquare).toggle(r);return!e.kingAttackers(i.king,p(e.turn),n).intersects(n)},e1=(e,t,i)=>{if(!d(i.king)||i.checkers.nonEmpty())return es.empty();let r=e.castles.rook[e.turn][t];if(!d(r)||e.castles.path[e.turn][t].intersects(e.board.occupied))return es.empty();let n=y(e.turn,t),s=eH(i.king,n),o=e.board.occupied.without(i.king);for(let t of s)if(e.kingAttackers(t,p(e.turn),o).nonEmpty())return es.empty();let a=C(e.turn,t),l=e.board.occupied.toggle(i.king).toggle(r).toggle(a);return e.kingAttackers(n,p(e.turn),l).nonEmpty()?es.empty():es.fromSquare(r)},e2=(e,t,i)=>{if(i.variantEnd)return es.empty();let r=e.board.get(t);if(!r||r.color!==e.turn)return es.empty();let n=eW(r,t,e.board.occupied);if("pawn"===r.role){let i=e.board[p(e.turn)];d(e.epSquare)&&(i=i.with(e.epSquare)),n=n.intersect(i);let r="white"===e.turn?8:-8,s=t+r;if(0<=s&&s<64&&!e.board.occupied.has(s)){n=n.with(s);let i="white"===e.turn?t<16:t>=48,o=s+r;i&&!e.board.occupied.has(o)&&(n=n.with(o))}return n}return(n=n.diff(e.board[e.turn]),t===i.king)?n.union(e1(e,"a",i)).union(e1(e,"h",i)):n},e3=(e,t)=>{if(u(t))return;let i=t.to-t.from;if((2===Math.abs(i)||e.board[e.turn].has(t.to))&&e.board.king.has(t.from))return i>0?"h":"a"},e5=(e,t)=>{let i=e3(e,t);if(!i)return t;let r=e.castles.rook[e.turn][i];return{from:t.from,to:d(r)?r:t.to}};class e8 extends eY{constructor(){super("crazyhouse")}reset(){super.reset(),this.pockets=el.empty()}setupUnchecked(e){super.setupUnchecked(e),this.board.promoted=e.board.promoted.intersect(e.board.occupied).diff(e.board.king).diff(e.board.pawn),this.pockets=e.pockets?e.pockets.clone():el.empty()}static default(){let e=new this;return e.reset(),e}static fromSetup(e,t){let i=new this;return i.setupUnchecked(e),i.validate(t).map(e=>i)}clone(){return super.clone()}validate(e){return super.validate(e).chain(e=>{var t,i;return(null===(t=this.pockets)||void 0===t?void 0:t.count("king"))?r.err(new ej(s.Kings)):((null===(i=this.pockets)||void 0===i?void 0:i.size())||0)+this.board.occupied.size()>64?r.err(new ej(s.Variant)):r.ok(void 0)})}hasInsufficientMaterial(e){return this.pockets?this.board.occupied.size()+this.pockets.size()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&0>=this.pockets.count("pawn")&&0>=this.pockets.count("rook")&&0>=this.pockets.count("queen"):super.hasInsufficientMaterial(e)}dropDests(e){var t,i;let r=this.board.occupied.complement().intersect((null===(t=this.pockets)||void 0===t?void 0:t[this.turn].hasNonPawns())?es.full():(null===(i=this.pockets)||void 0===i?void 0:i[this.turn].hasPawns())?es.backranks().complement():es.empty());if(!(d((e=e||this.ctx()).king)&&e.checkers.nonEmpty()))return r;{let t=e.checkers.singleSquare();return d(t)?r.intersect(eH(t,e.king)):es.empty()}}}class e6 extends eY{constructor(){super("atomic")}static default(){let e=new this;return e.reset(),e}static fromSetup(e,t){let i=new this;return i.setupUnchecked(e),i.validate(t).map(e=>i)}clone(){return super.clone()}validate(e){if(this.board.occupied.isEmpty())return r.err(new ej(s.Empty));if(this.board.king.size()>2)return r.err(new ej(s.Kings));let t=this.board.kingOf(p(this.turn));return d(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?r.err(new ej(s.OppositeCheck)):es.backranks().intersects(this.board.pawn)?r.err(new ej(s.PawnsOnBackrank)):(null==e?void 0:e.ignoreImpossibleCheck)?r.ok(void 0):this.validateCheckers():r.err(new ej(s.Kings))}validateCheckers(){return d(this.epSquare)?r.ok(void 0):super.validateCheckers()}kingAttackers(e,t,i){let r=this.board.pieces(t,"king");return r.isEmpty()||eP(e).intersects(r)?es.empty():super.kingAttackers(e,t,i)}playCaptureAt(e,t){for(let i of(super.playCaptureAt(e,t),this.board.take(e),eP(e).intersect(this.board.occupied).diff(this.board.pawn))){let e=this.board.take(i);(null==e?void 0:e.role)==="rook"&&this.castles.discardRook(i),(null==e?void 0:e.role)==="king"&&this.castles.discardColor(e.color)}}hasInsufficientMaterial(e){if(this.board.pieces(p(e),"king").isEmpty())return!1;if(this.board[e].diff(this.board.king).isEmpty())return!0;if(this.board[p(e)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(es.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(es.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(es.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(es.darkSquares())}return!1}return!(this.board.queen.nonEmpty()||this.board.pawn.nonEmpty())&&(1===this.board.knight.union(this.board.bishop).union(this.board.rook).size()||!!this.board.occupied.equals(this.board.knight.union(this.board.king))&&2>=this.board.knight.size())}dests(e,t){t=t||this.ctx();let i=es.empty();for(let r of e2(this,e,t)){let t=this.clone();t.play({from:e,to:r});let n=t.board.kingOf(this.turn);d(n)&&(!d(t.board.kingOf(t.turn))||t.kingAttackers(n,t.turn,t.board.occupied).isEmpty())&&(i=i.with(r))}return i}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(e){for(let e of l)if(this.board.pieces(e,"king").isEmpty())return{winner:p(e)}}}class e4 extends eY{constructor(){super("antichess")}reset(){super.reset(),this.castles=eQ.empty()}setupUnchecked(e){super.setupUnchecked(e),this.castles=eQ.empty()}static default(){let e=new this;return e.reset(),e}static fromSetup(e,t){let i=new this;return i.setupUnchecked(e),i.validate(t).map(e=>i)}clone(){return super.clone()}validate(e){return this.board.occupied.isEmpty()?r.err(new ej(s.Empty)):es.backranks().intersects(this.board.pawn)?r.err(new ej(s.PawnsOnBackrank)):r.ok(void 0)}kingAttackers(e,t,i){return es.empty()}ctx(){let e=super.ctx();if(d(this.epSquare)&&eN(p(this.turn),this.epSquare).intersects(this.board.pieces(this.turn,"pawn")))return e.mustCapture=!0,e;let t=this.board[p(this.turn)];for(let i of this.board[this.turn])if(e2(this,i,e).intersects(t)){e.mustCapture=!0;break}return e}dests(e,t){let i=e2(this,e,t=t||this.ctx()),r=this.board[p(this.turn)];return i.intersect(t.mustCapture?d(this.epSquare)&&"pawn"===this.board.getRole(e)?r.with(this.epSquare):r:es.full())}hasInsufficientMaterial(e){if(this.board[e].isEmpty())return!1;if(this.board[p(e)].isEmpty())return!0;if(this.board.occupied.equals(this.board.bishop)){let t=this.board[e].intersects(es.lightSquares()),i=this.board[e].intersects(es.darkSquares()),r=this.board[p(e)].isDisjoint(es.lightSquares()),n=this.board[p(e)].isDisjoint(es.darkSquares());return t&&r||i&&n}return!!this.board.occupied.equals(this.board.knight)&&2===this.board.occupied.size()&&this.board.white.intersects(es.lightSquares())!==this.board.black.intersects(es.darkSquares())!=(this.turn===e)}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(e){if((e=e||this.ctx()).variantEnd||this.isStalemate(e))return{winner:this.turn}}}class e9 extends eY{constructor(){super("kingofthehill")}static default(){let e=new this;return e.reset(),e}static fromSetup(e,t){let i=new this;return i.setupUnchecked(e),i.validate(t).map(e=>i)}clone(){return super.clone()}hasInsufficientMaterial(e){return!1}isVariantEnd(){return this.board.king.intersects(es.center())}variantOutcome(e){for(let e of l)if(this.board.pieces(e,"king").intersects(es.center()))return{winner:e}}}class e7 extends eY{constructor(){super("3check")}reset(){super.reset(),this.remainingChecks=eh.default()}setupUnchecked(e){var t;super.setupUnchecked(e),this.remainingChecks=(null===(t=e.remainingChecks)||void 0===t?void 0:t.clone())||eh.default()}static default(){let e=new this;return e.reset(),e}static fromSetup(e,t){let i=new this;return i.setupUnchecked(e),i.validate(t).map(e=>i)}clone(){return super.clone()}hasInsufficientMaterial(e){return this.board.pieces(e,"king").equals(this.board[e])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(e){if(this.remainingChecks){for(let e of l)if(this.remainingChecks[e]<=0)return{winner:e}}}}let te=()=>{let e=eo.empty();return e.occupied=new es(65535,0),e.promoted=es.empty(),e.white=new es(61680,0),e.black=new es(3855,0),e.pawn=es.empty(),e.knight=new es(6168,0),e.bishop=new es(9252,0),e.rook=new es(16962,0),e.queen=new es(129,0),e.king=new es(33024,0),e};class tt extends eY{constructor(){super("racingkings")}reset(){this.board=te(),this.pockets=void 0,this.turn="white",this.castles=eQ.empty(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(e){super.setupUnchecked(e),this.castles=eQ.empty()}static default(){let e=new this;return e.reset(),e}static fromSetup(e,t){let i=new this;return i.setupUnchecked(e),i.validate(t).map(e=>i)}clone(){return super.clone()}validate(e){return this.isCheck()||this.board.pawn.nonEmpty()?r.err(new ej(s.Variant)):super.validate(e)}dests(e,t){if(e===(t=t||this.ctx()).king)return super.dests(e,t);let i=es.empty();for(let r of super.dests(e,t)){let t={from:e,to:r},n=this.clone();n.play(t),n.isCheck()||(i=i.with(r))}return i}hasInsufficientMaterial(e){return!1}isVariantEnd(){let e=es.fromRank(7),t=this.board.king.intersect(e);if(t.isEmpty())return!1;if("white"===this.turn||t.intersects(this.board.black))return!0;let i=this.board.kingOf("black");if(d(i)){let t=this.board.occupied.without(i);for(let r of eP(i).intersect(e).diff(this.board.black))if(this.kingAttackers(r,"white",t).isEmpty())return!1}return!0}variantOutcome(e){if(e?!e.variantEnd:!this.isVariantEnd())return;let t=es.fromRank(7),i=this.board.pieces("black","king").intersects(t),r=this.board.pieces("white","king").intersects(t);return i&&!r?{winner:"black"}:r&&!i?{winner:"white"}:{winner:void 0}}}let ti=()=>{let e=eo.empty();return e.occupied=new es(0xffffffff,0xffff0066),e.promoted=es.empty(),e.white=new es(0xffffffff,102),e.black=new es(0,0xffff0000),e.pawn=new es(0xffffffff,0xff0066),e.knight=new es(0,0x42000000),e.bishop=new es(0,0x24000000),e.rook=new es(0,0x81000000),e.queen=new es(0,0x8000000),e.king=new es(0,0x10000000),e};class tr extends eY{constructor(){super("horde")}reset(){this.board=ti(),this.pockets=void 0,this.turn="white",this.castles=eQ.default(),this.castles.discardColor("white"),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}static default(){let e=new this;return e.reset(),e}static fromSetup(e,t){let i=new this;return i.setupUnchecked(e),i.validate(t).map(e=>i)}clone(){return super.clone()}validate(e){if(this.board.occupied.isEmpty())return r.err(new ej(s.Empty));if(1!==this.board.king.size())return r.err(new ej(s.Kings));let t=this.board.kingOf(p(this.turn));if(d(t)&&this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty())return r.err(new ej(s.OppositeCheck));for(let e of l){let t=this.board.pieces(e,"king").isEmpty()?es.backrank(p(e)):es.backranks();if(this.board.pieces(e,"pawn").intersects(t))return r.err(new ej(s.PawnsOnBackrank))}return(null==e?void 0:e.ignoreImpossibleCheck)?r.ok(void 0):this.validateCheckers()}hasInsufficientMaterial(e){if(this.board.pieces(e,"king").nonEmpty())return!1;let t=e=>"light"===e?"dark":"light",i=e=>"light"===e?es.lightSquares():es.darkSquares(),r=e=>{let t=this.board.pieces(e,"bishop");return t.intersects(es.darkSquares())&&t.intersects(es.lightSquares())},n=ea.fromBoard(this.board,e),s=t=>i(t).intersect(this.board.pieces(e,"bishop")).size(),o=s("light")>=1?"light":"dark",a=n.pawn+n.knight+n.rook+n.queen+Math.min(s("dark"),2)+Math.min(s("light"),2),l=ea.fromBoard(this.board,p(e)),h=t=>i(t).intersect(this.board.pieces(p(e),"bishop")).size(),c=l.size();if(0===a)return!0;if(a>=4||(n.pawn>=1||n.queen>=1)&&a>=2||n.rook>=1&&a>=2&&!(2===a&&1===n.rook&&1===n.bishop&&1==c-h(o)))return!1;if(1===a){if(1===c);else if(1===n.queen)return!(l.pawn>=1||l.rook>=1||h("light")>=2||h("dark")>=2);else if(1===n.pawn){let t=this.board.pieces(e,"pawn").last(),i=this.clone();i.board.set(t,{color:e,role:"queen"});let r=this.clone();return r.board.set(t,{color:e,role:"knight"}),i.hasInsufficientMaterial(e)&&r.hasInsufficientMaterial(e)}else if(1===n.rook)return!(l.pawn>=2||l.rook>=1&&l.pawn>=1||l.rook>=1&&l.knight>=1||l.pawn>=1&&l.knight>=1);else if(1===n.bishop)return!(h(t(o))>=2||h(t(o))>=1&&l.pawn>=1||l.pawn>=2);else if(1===n.knight)return!(c>=4&&(l.knight>=2||l.pawn>=2||l.rook>=1&&l.knight>=1||l.rook>=1&&l.bishop>=1||l.knight>=1&&l.bishop>=1||l.rook>=1&&l.pawn>=1||l.knight>=1&&l.pawn>=1||l.bishop>=1&&l.pawn>=1||r(p(e))&&l.pawn>=1)&&(2>h("dark")||c-h("dark")>=3)&&(2>h("light")||c-h("light")>=3))}else if(2===a){if(1===c);else if(2===n.knight)return l.pawn+l.bishop+l.knight<1;else if(r(e))return!(l.pawn>=1||l.bishop>=1||l.knight>=1&&l.rook+l.queen>=1);else if(!(n.bishop>=1)||!(n.knight>=1))return!(l.pawn>=1&&h(t(o))>=1||l.pawn>=1&&l.knight>=1||h(t(o))>=1&&l.knight>=1||h(t(o))>=2||l.knight>=2||l.pawn>=2);else return!(l.pawn>=1||h(t(o))>=1||c-h(o)>=3)}else if(3===a)return!(2===n.knight&&1===n.bishop||3===n.knight||r(e))&&1===c;return!0}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(e){return this.board.white.isEmpty()?{winner:"black"}:this.board.black.isEmpty()?{winner:"white"}:void 0}}let tn=e=>{switch(e){case"chess":return eZ.default();case"antichess":return e4.default();case"atomic":return e6.default();case"horde":return tr.default();case"racingkings":return tt.default();case"kingofthehill":return e9.default();case"3check":return e7.default();case"crazyhouse":return e8.default()}},ts=(e,t,i)=>{switch(e){case"chess":return eZ.fromSetup(t,i);case"antichess":return e4.fromSetup(t,i);case"atomic":return e6.fromSetup(t,i);case"horde":return tr.fromSetup(t,i);case"racingkings":return tt.fromSetup(t,i);case"kingofthehill":return e9.fromSetup(t,i);case"3check":return e7.fromSetup(t,i);case"crazyhouse":return e8.fromSetup(t,i)}},to=(e=tc)=>({headers:e(),moves:new ta});class ta{constructor(){this.children=[]}*mainline(){let e=this;for(;e.children.length;){let t=e.children[0];yield t.data,e=t}}}class tl extends ta{constructor(e){super(),this.data=e}}let th=(e,t,i)=>{let r;let n=new ta,s=[{before:e,after:n,ctx:t}];for(;r=s.pop();)for(let e=0;e<r.before.children.length;e++){let t=e<r.before.children.length-1?r.ctx.clone():r.ctx,n=r.before.children[e],o=i(t,n.data,e);if(d(o)){let e=new tl(o);r.after.children.push(e),s.push({before:n,after:e,ctx:t})}}return n},tc=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),tu=e=>/^\s*$/.test(e),td=e=>e.startsWith("%");class tp extends Error{}class tf{constructor(e,t=tc,i=1e6){this.emitGame=e,this.initHeaders=t,this.maxBudget=i,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=to(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(e){if(this.budget-=e,this.budget<0)throw new tp("ERR_PGN_BUDGET")}parse(e,t){if(!(this.budget<0))try{let i=0;for(;;){let t=e.indexOf("\n",i);if(-1===t)break;let r=t>i&&"\r"===e[t-1]?t-1:t;this.consumeBudget(t-i),this.lineBuf.push(e.slice(i,r)),i=t+1,this.handleLine()}this.consumeBudget(e.length-i),this.lineBuf.push(e.slice(i)),(null==t?void 0:t.stream)||(this.handleLine(),this.emit(void 0))}catch(e){this.emit(e)}}handleLine(){let e=!0,t=this.lineBuf.join("");this.lineBuf=[];e:for(;;)switch(this.state){case 0:t.startsWith("\uFEFF")&&(t=t.slice(1)),this.state=1;case 1:if(tu(t)||td(t))return;this.found=!0,this.state=2;case 2:{if(td(t))return;let i=!0;for(;i;)i=!1,t=t.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(t,r,n)=>(this.consumeBudget(200),this.game.headers.set(r,n.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),i=!0,e=!1,""));if(tu(t))return;this.state=3}case 3:{let i;if(e){if(td(t))return;if(tu(t))return this.emit(void 0)}let r=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|O-O-O|0-0-0|O-O|0-0)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1-0|0-1|1\/2-1\/2/g;for(;i=r.exec(t);){let e=this.stack[this.stack.length-1],n=i[0];if(";"===n)break;if(n.startsWith("$"))this.handleNag(parseInt(n.slice(1),10));else if("!"===n)this.handleNag(1);else if("?"===n)this.handleNag(2);else if("!!"===n)this.handleNag(3);else if("??"===n)this.handleNag(4);else if("!?"===n)this.handleNag(5);else if("?!"===n)this.handleNag(6);else if("1-0"===n||"0-1"===n||"1/2-1/2"===n||"*"===n)1===this.stack.length&&"*"!==n&&this.game.headers.set("Result",n);else if("("===n)this.consumeBudget(100),this.stack.push({parent:e.parent,root:!1});else if(")"===n)this.stack.length>1&&this.stack.pop();else if("{"===n){let e=r.lastIndex,i=" "===t[e]?e+1:e;t=t.slice(i),this.state=4;continue e}else this.consumeBudget(100),"Z0"===n||"0000"===n||"@@@@"===n?n="--":n.startsWith("0")&&(n=n.replace(/0/g,"O")),e.node&&(e.parent=e.node),e.node=new tl({san:n,startingComments:e.startingComments}),e.startingComments=void 0,e.root=!1,e.parent.children.push(e.node)}return}case 4:{let i=t.indexOf("}");if(-1===i){this.commentBuf.push(t);return}{let r=i>0&&" "===t[i-1]?i-1:i;this.commentBuf.push(t.slice(0,r)),this.handleComment(),t=t.slice(i),this.state=3,e=!1}}}}handleNag(e){var t;this.consumeBudget(50);let i=this.stack[this.stack.length-1];i.node&&((t=i.node.data).nags||(t.nags=[]),i.node.data.nags.push(e))}handleComment(){var e,t;this.consumeBudget(100);let i=this.stack[this.stack.length-1],r=this.commentBuf.join("\n");this.commentBuf=[],i.node?((e=i.node.data).comments||(e.comments=[]),i.node.data.comments.push(r)):i.root?((t=this.game).comments||(t.comments=[]),this.game.comments.push(r)):(i.startingComments||(i.startingComments=[]),i.startingComments.push(r))}emit(e){if(4===this.state&&this.handleComment(),e)return this.emitGame(this.game,e);this.found&&this.emitGame(this.game,void 0),this.resetGame()}}let tm=(e,t=tc)=>{let i=[];return new tf(e=>i.push(e),t,NaN).parse(e),i},tg=e=>{switch((e||"chess").toLowerCase()){case"chess":case"chess960":case"chess 960":case"standard":case"from position":case"classical":case"normal":case"fischerandom":case"fischerrandom":case"fischer random":case"wild/0":case"wild/1":case"wild/2":case"wild/3":case"wild/4":case"wild/5":case"wild/6":case"wild/7":case"wild/8":case"wild/8a":return"chess";case"crazyhouse":case"crazy house":case"house":case"zh":return"crazyhouse";case"king of the hill":case"koth":case"kingofthehill":return"kingofthehill";case"three-check":case"three check":case"threecheck":case"three check chess":case"3-check":case"3 check":case"3check":return"3check";case"antichess":case"anti chess":case"anti":return"antichess";case"atomic":case"atom":case"atomic chess":return"atomic";case"horde":case"horde chess":return"horde";case"racing kings":case"racingkings":case"racing":case"race":return"racingkings";default:return}},tv=(e,t)=>{let i=tg(e.get("Variant"));if(!i)return r.err(new ej(s.Variant));let n=e.get("FEN");return n?eb(n).chain(e=>ts(i,e,t)):r.ok(tn(i))},tb=e=>{let t=function(e){switch(e){case"G":return"green";case"R":return"red";case"Y":return"yellow";case"B":return"blue";default:return}}(e.slice(0,1)),i=b(e.slice(1,3)),r=b(e.slice(3,5));if(t&&d(i)){if(3===e.length)return{color:t,from:i,to:i};if(5===e.length&&d(r))return{color:t,from:i,to:r}}},tk=e=>{let t,i,r;let n=[];return{text:e.replace(/\s?\[%(emt|clk)\s(\d{1,5}):(\d{1,2}):(\d{1,2}(?:\.\d{0,3})?)\]\s?/g,(e,r,n,s,o)=>{let a=3600*parseInt(n,10)+60*parseInt(s,10)+parseFloat(o);return"emt"===r?t=a:"clk"===r&&(i=a),"  "}).replace(/\s?\[%(?:csl|cal)\s([RGYB][a-h][1-8](?:[a-h][1-8])?(?:,[RGYB][a-h][1-8](?:[a-h][1-8])?)*)\]\s?/g,(e,t)=>{for(let e of t.split(","))n.push(tb(e));return"  "}).replace(/\s?\[%eval\s(?:#([+-]?\d{1,5})|([+-]?(?:\d{1,5}|\d{0,5}\.\d{1,2})))(?:,(\d{1,5}))?\]\s?/g,(e,t,i,n)=>{let s=n&&parseInt(n,10);return r=t?{mate:parseInt(t,10),depth:s}:{pawns:parseFloat(i),depth:s},"  "}).trim(),shapes:n,emt:t,clock:i,evaluation:r}},tw=(e,t)=>{let i="";if(u(t))"pawn"!==t.role&&(i=g(t.role).toUpperCase()),i+="@"+k(t.to);else{let r=e.board.getRole(t.from);if(!r)return"--";if("king"===r&&(e.board[e.turn].has(t.to)||2===Math.abs(t.to-t.from)))i=t.to>t.from?"O-O":"O-O-O";else{let n=e.board.occupied.has(t.to)||"pawn"===r&&m(t.from)!==m(t.to);if("pawn"!==r){let n;if(i=g(r).toUpperCase(),(n=(n="king"===r?eP(t.to).intersect(e.board.king):"queen"===r?eF(t.to,e.board.occupied).intersect(e.board.queen):"rook"===r?eU(t.to,e.board.occupied).intersect(e.board.rook):"bishop"===r?eI(t.to,e.board.occupied).intersect(e.board.bishop):eR(t.to).intersect(e.board.knight)).intersect(e.board[e.turn]).without(t.from)).nonEmpty()){let r=e.ctx();for(let i of n)e.dests(i,r).has(t.to)||(n=n.without(i));if(n.nonEmpty()){let e=!1,r=n.intersects(es.fromRank(f(t.from)));n.intersects(es.fromFile(m(t.from)))?e=!0:r=!0,r&&(i+=o[m(t.from)]),e&&(i+=a[f(t.from)])}}}else n&&(i=o[m(t.from)]);n&&(i+="x"),i+=k(t.to),t.promotion&&(i+="="+g(t.promotion).toUpperCase())}}return i},ty=(e,t)=>{var i;let r=tw(e,t);return(e.play(t),null===(i=e.outcome())||void 0===i?void 0:i.winner)?r+"#":e.isCheck()?r+"+":r},tC=(e,t)=>{let i;let r=e.ctx(),n=t.match(/^([NBRQK])?([a-h])?([1-8])?[-x]?([a-h][1-8])(?:=?([nbrqkNBRQK]))?[+#]?$/);if(!n){let i;if("O-O"===t||"O-O+"===t||"O-O#"===t?i="h":("O-O-O"===t||"O-O-O+"===t||"O-O-O#"===t)&&(i="a"),i){let t=e.castles.rook[e.turn][i];if(!d(r.king)||!d(t)||!e.dests(r.king,r).has(t))return;return{from:r.king,to:t}}let n=t.match(/^([pnbrqkPNBRQK])?@([a-h][1-8])[+#]?$/);if(!n)return;let s={role:n[1]?v(n[1]):"pawn",to:b(n[2])};return e.isLegal(s,r)?s:void 0}let s=n[1]?v(n[1]):"pawn",o=b(n[4]),a=n[5]?v(n[5]):void 0;if(!!a!==("pawn"===s&&es.backranks().has(o))||"king"===a&&"antichess"!==e.rules)return;let l=e.board.pieces(e.turn,s);"pawn"!==s||n[2]?n[2]&&(l=l.intersect(es.fromFile(n[2].charCodeAt(0)-97))):l=l.intersect(es.fromFile(m(o))),n[3]&&(l=l.intersect(es.fromRank(n[3].charCodeAt(0)-49)));let h="pawn"===s?es.fromFile(m(o)):es.empty();for(let t of l=l.intersect(h.union(eW({color:p(e.turn),role:s},o,e.board.occupied))))if(e.dests(t,r).has(o)){if(d(i))return;i=t}if(d(i))return{from:i,to:o,promotion:a}};class tx{constructor(e,t,i){this.pos=e,this.path=t,this.clocks=i,this.clone=()=>new tx(this.pos.clone(),this.path,{...this.clocks})}}let tS=e=>{let t=e.map(tk),i=e=>e.reduce((e,t)=>t,void 0);return{texts:t.map(e=>e.text).filter(e=>!!e),shapes:t.flatMap(e=>e.shapes),clock:i(t.map(e=>e.clock)),emt:i(t.map(e=>e.emt))}},tE=(e,t=!1)=>{var i,r;let n=tm(e)[0]||tm("*")[0],s=tv(n.headers).unwrap(),o=eE(s.toSetup()),a=tS(n.comments||[]),l=new Map(Array.from(n.headers,([e,t])=>[e.toLowerCase(),t])),h=function(e,t){var i;let r=e.get("source")||e.get("site"),n=null===(i=e.get("timecontrol"))||void 0===i?void 0:i.split("+").map(e=>parseInt(e)),s=n&&n[0]?{initial:n[0],increment:n[1]||0}:void 0,o=e.get("orientation");return{externalLink:r&&r.match(/^https?:\/\//)?r:void 0,isLichess:!!(t&&(null==r?void 0:r.startsWith(t))),timeControl:s,orientation:"white"===o||"black"===o?o:void 0,result:e.get("result")}}(l,t);return new j({fen:o,turn:s.turn,check:s.isCheck(),pos:s.clone(),comments:a.texts,shapes:a.shapes,clocks:{white:(null===(i=h.timeControl)||void 0===i?void 0:i.initial)||a.clock,black:(null===(r=h.timeControl)||void 0===r?void 0:r.initial)||a.clock}},t_(s,n.moves,h),function(e,t){let i=(t,i)=>{let r=e.get(`${t}${i}`);return"?"==r||""==r?void 0:r},r=e=>{let r=i(e,"");return{name:r,title:i(e,"title"),rating:parseInt(i(e,"elo")||"")||void 0,isLichessUser:t.isLichess&&!!(null==r?void 0:r.match(/^[a-z0-9][a-z0-9_-]{0,28}[a-z0-9]$/i))}};return{white:r("white"),black:r("black")}}(l,h),h)},t_=(e,t,i)=>th(t,new tx(e,H.root,{}),(e,t,r)=>{let n=tC(e.pos,t.san);if(!n)return;let s=X(n),o=e.path.append(s),a=ty(e.pos,n);e.path=o;let l=e.pos.toSetup(),h=tS(t.comments||[]),c=tS(t.startingComments||[]),u=[...h.shapes,...c.shapes],d=(l.fullmoves-1)*2+("white"===e.pos.turn?0:1),p=e.clocks=tM(e.clocks,e.pos.turn,h.clock);return d<2&&i.timeControl&&(p={white:i.timeControl.initial,black:i.timeControl.initial,...p}),{path:o,ply:d,move:n,san:a,uci:w(n),fen:eE(e.pos.toSetup()),turn:e.pos.turn,check:e.pos.isCheck(),comments:h.texts,startingComments:c.texts,nags:t.nags||[],shapes:u,clocks:p,emt:h.emt}}),tM=(e,t,i)=>"white"==t?{...e,black:i}:{...e,white:i};class tq{constructor(e,t){this.opts=e,this.redraw=t,this.flipped=!1,this.pane="board",this.autoScrollRequested=!1,this.curNode=()=>this.game.nodeAt(this.path)||this.game.moves,this.curData=()=>this.game.dataAt(this.path)||this.game.initial,this.goTo=(e,t=!0)=>{var i,r;let n="first"==e?H.root:"prev"==e?this.path.init():"next"==e?null===(r=null===(i=this.game.nodeAt(this.path))||void 0===i?void 0:i.children[0])||void 0===r?void 0:r.data.path:this.game.pathAtMainlinePly("last");this.toPath(n||this.path,t)},this.canGoTo=e=>"prev"==e||"first"==e?!this.path.empty():!!this.curNode().children[0],this.toPath=(e,t=!0)=>{this.path=e,this.pane="board",this.autoScrollRequested=!0,this.redrawGround(),this.redraw(),t&&this.focus()},this.focus=()=>{var e;return null===(e=this.div)||void 0===e?void 0:e.focus()},this.toggleMenu=()=>{this.pane="board"==this.pane?"menu":"board",this.redraw()},this.togglePgn=()=>{this.pane="pgn"==this.pane?"board":"pgn",this.redraw()},this.orientation=()=>{let e=this.opts.orientation||"white";return this.flipped?p(e):e},this.flip=()=>{this.flipped=!this.flipped,this.pane="board",this.redrawGround(),this.redraw()},this.cgState=()=>{var e;let t=this.curData(),i=Z(t)?R(t.uci):null===(e=this.opts.chessground)||void 0===e?void 0:e.lastMove;return{fen:t.fen,orientation:this.orientation(),check:t.check,lastMove:i,turnColor:t.turn}},this.analysisUrl=()=>this.game.metadata.isLichess&&this.game.metadata.externalLink||`https://lichess.org/analysis/${this.curData().fen.replace(" ","_")}?color=${this.orientation()}`,this.practiceUrl=()=>`${this.analysisUrl()}#practice`,this.setGround=e=>{this.ground=e,this.redrawGround()},this.redrawGround=()=>this.withGround(e=>{e.set(this.cgState()),e.setShapes(this.curData().shapes.map(e=>({orig:k(e.from),dest:k(e.to),brush:e.color})))}),this.withGround=e=>this.ground&&e(this.ground),this.game=tE(e.pgn,e.lichess),e.orientation=e.orientation||this.game.metadata.orientation,this.translate=function(e){return t=>e&&e(t)||x(t)}(e.translate),this.path=this.game.pathAtMainlinePly(e.initialPly)}}let tO=(e,t)=>Math.abs(e-t),tA=e=>(t,i,r,n)=>2>tO(t,r)&&("white"===e?n===i+1||i<=1&&n===i+2&&t===r:n===i-1||i>=6&&n===i-2&&t===r),tP=(e,t,i,r)=>{let n=tO(e,i),s=tO(t,r);return 1===n&&2===s||2===n&&1===s},tR=(e,t,i,r)=>tO(e,i)===tO(t,r),tN=(e,t,i,r)=>e===i||t===r,tB=(e,t,i,r)=>tR(e,t,i,r)||tN(e,t,i,r),tT=(e,t,i)=>(r,n,s,o)=>2>tO(r,s)&&2>tO(n,o)||i&&n===o&&n===("white"===e?0:7)&&(4===r&&(2===s&&t.includes(0)||6===s&&t.includes(7))||t.includes(s));function tL(e,t,i){let r=e.get(t);if(!r)return[];let n=P(t),s=r.role,o="pawn"===s?tA(r.color):"knight"===s?tP:"bishop"===s?tR:"rook"===s?tN:"queen"===s?tB:tT(r.color,function(e,t){let i="white"===t?"1":"8",r=[];for(let[n,s]of e)n[1]===i&&s.color===t&&"rook"===s.role&&r.push(P(n)[0]);return r}(e,r.color),i);return N.filter(e=>(n[0]!==e[0]||n[1]!==e[1])&&o(n[0],n[1],e[0],e[1])).map(A)}function tz(e,...t){e&&setTimeout(()=>e(...t),1)}function tK(e){e.premovable.current&&(e.premovable.current=void 0,tz(e.premovable.events.unset))}function t$(e){let t=e.predroppable;t.current&&(t.current=void 0,tz(t.events.unset))}function tD(e,t,i){let r=e.pieces.get(t),n=e.pieces.get(i);if(t===i||!r)return!1;let s=n&&n.color!==r.color?n:void 0;return i===e.selected&&tj(e),tz(e.events.move,t,i,s),!function(e,t,i){if(!e.autoCastle)return!1;let r=e.pieces.get(t);if(!r||"king"!==r.role)return!1;let n=P(t),s=P(i);if(0!==n[1]&&7!==n[1]||n[1]!==s[1])return!1;4!==n[0]||e.pieces.has(i)||(6===s[0]?i=A([7,s[1]]):2===s[0]&&(i=A([0,s[1]])));let o=e.pieces.get(i);return!!o&&o.color===r.color&&"rook"===o.role&&(e.pieces.delete(t),e.pieces.delete(i),n[0]<s[0]?(e.pieces.set(A([6,s[1]]),r),e.pieces.set(A([5,s[1]]),o)):(e.pieces.set(A([2,s[1]]),r),e.pieces.set(A([3,s[1]]),o)),!0)}(e,t,i)&&(e.pieces.set(i,r),e.pieces.delete(t)),e.lastMove=[t,i],e.check=void 0,tz(e.events.change),s||!0}function tI(e,t,i,r){if(e.pieces.has(i)){if(!r)return!1;e.pieces.delete(i)}return tz(e.events.dropNewPiece,t,i),e.pieces.set(i,t),e.lastMove=[i],e.check=void 0,tz(e.events.change),e.movable.dests=void 0,e.turnColor=T(e.turnColor),!0}function tU(e,t,i){let r=tD(e,t,i);return r&&(e.movable.dests=void 0,e.turnColor=T(e.turnColor),e.animation.current=void 0),r}function tF(e,t,i){if(tQ(e,t,i)){let r=tU(e,t,i);if(r){let n=e.hold.stop();tj(e);let s={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:n};return!0!==r&&(s.captured=r),tz(e.movable.events.after,t,i,s),!0}}else if(function(e,t,i){var r,n;let s=null!==(n=null===(r=e.premovable.customDests)||void 0===r?void 0:r.get(t))&&void 0!==n?n:tL(e.pieces,t,e.premovable.castle);return t!==i&&tY(e,t)&&s.includes(i)}(e,t,i)){var r;return r={ctrlKey:e.stats.ctrlKey},t$(e),e.premovable.current=[t,i],tz(e.premovable.events.set,t,i,r),tj(e),!0}return tj(e),!1}function tW(e,t,i,r){let n=e.pieces.get(t);if(n&&(function(e,t,i){let r=e.pieces.get(t);return!!r&&(t===i||!e.pieces.has(i))&&("both"===e.movable.color||e.movable.color===r.color&&e.turnColor===r.color)}(e,t,i)||r))e.pieces.delete(t),tI(e,n,i,r),tz(e.movable.events.afterNewPiece,n.role,i,{premove:!1,predrop:!1});else if(n&&function(e,t,i){let r=e.pieces.get(t),n=e.pieces.get(i);return!!r&&(!n||n.color!==e.movable.color)&&e.predroppable.enabled&&("pawn"!==r.role||"1"!==i[1]&&"8"!==i[1])&&e.movable.color===r.color&&e.turnColor!==r.color}(e,t,i)){var s;s=n.role,tK(e),e.predroppable.current={role:s,key:i},tz(e.predroppable.events.set,s,i)}else tK(e),t$(e);e.pieces.delete(t),tj(e)}function tG(e,t,i){if(tz(e.events.select,t),e.selected){if(e.selected!==t||e.draggable.enabled){if((e.selectable.enabled||i)&&e.selected!==t&&tF(e,e.selected,t)){e.stats.dragged=!1;return}}else{tj(e),e.hold.cancel();return}}(e.selectable.enabled||e.draggable.enabled)&&(tV(e,t)||tY(e,t))&&(tH(e,t),e.hold.start())}function tH(e,t){e.selected=t,tY(e,t)?e.premovable.customDests||(e.premovable.dests=tL(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function tj(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function tV(e,t){let i=e.pieces.get(t);return!!i&&("both"===e.movable.color||e.movable.color===i.color&&e.turnColor===i.color)}let tQ=(e,t,i)=>{var r,n;return t!==i&&tV(e,t)&&(e.movable.free||!!(null===(n=null===(r=e.movable.dests)||void 0===r?void 0:r.get(t))||void 0===n?void 0:n.includes(i)))};function tY(e,t){let i=e.pieces.get(t);return!!i&&e.premovable.enabled&&e.movable.color===i.color&&e.turnColor!==i.color}function tZ(e){let t=e.premovable.current;if(!t)return!1;let i=t[0],r=t[1],n=!1;if(tQ(e,i,r)){let t=tU(e,i,r);if(t){let s={premove:!0};!0!==t&&(s.captured=t),tz(e.movable.events.after,i,r,s),n=!0}}return tK(e),n}function tX(e){tK(e),t$(e),tj(e)}function tJ(e){e.movable.color=e.movable.dests=e.animation.current=void 0,tX(e)}function t0(e,t,i){let r=Math.floor(8*(e[0]-i.left)/i.width);t||(r=7-r);let n=7-Math.floor(8*(e[1]-i.top)/i.height);return t||(n=7-n),r>=0&&r<8&&n>=0&&n<8?A([r,n]):void 0}let t1=e=>"white"===e.orientation,t2="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",t3={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},t5={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function t8(e){"start"===e&&(e=t2);let t=new Map,i=7,r=0;for(let n of e)switch(n){case" ":case"[":return t;case"/":if(--i<0)return t;r=0;break;case"~":{let e=t.get(A([r-1,i]));e&&(e.promoted=!0);break}default:{let e=n.charCodeAt(0);if(e<57)r+=e-48;else{let e=n.toLowerCase();t.set(A([r,i]),{role:t3[e],color:n===e?"black":"white"}),++r}}}return t}function t6(e,t){t.animation&&(t9(e.animation,t.animation),70>(e.animation.duration||0)&&(e.animation.enabled=!1))}function t4(e,t){var i,r,n;if((null===(i=t.movable)||void 0===i?void 0:i.dests)&&(e.movable.dests=void 0),(null===(r=t.drawable)||void 0===r?void 0:r.autoShapes)&&(e.drawable.autoShapes=[]),t9(e,t),t.fen&&(e.pieces=t8(t.fen),e.drawable.shapes=(null===(n=t.drawable)||void 0===n?void 0:n.shapes)||[]),"check"in t&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(let[i,r]of e.pieces)"king"===r.role&&r.color===t&&(e.check=i)}(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&tH(e,e.selected),t6(e,t),!e.movable.rookCastle&&e.movable.dests){let t="white"===e.movable.color?"1":"8",i="e"+t,r=e.movable.dests.get(i),n=e.pieces.get(i);if(!r||!n||"king"!==n.role)return;e.movable.dests.set(i,r.filter(e=>!(e==="a"+t&&r.includes("c"+t))&&!(e==="h"+t&&r.includes("g"+t))))}}function t9(e,t){for(let i in t)Object.prototype.hasOwnProperty.call(t,i)&&(Object.prototype.hasOwnProperty.call(e,i)&&t7(e[i])&&t7(t[i])?t9(e[i],t[i]):e[i]=t[i])}function t7(e){if("object"!=typeof e||null===e)return!1;let t=Object.getPrototypeOf(e);return t===Object.prototype||null===t}let ie=(e,t)=>t.animation.enabled?function(e,t){let i=new Map(t.pieces),r=e(t),n=function(e,t){let i,r,n;let s=new Map,o=[],a=new Map,l=[],h=[],c=new Map;for(let[t,i]of e)c.set(t,ii(t,i));for(let e of O)i=t.pieces.get(e),r=c.get(e),i?r?z(i,r.piece)||(l.push(r),h.push(ii(e,i))):h.push(ii(e,i)):r&&l.push(r);for(let e of h)(r=ir(e,l.filter(t=>z(e.piece,t.piece))))&&(n=[r.pos[0]-e.pos[0],r.pos[1]-e.pos[1]],s.set(e.key,n.concat(n)),o.push(r.key));for(let e of l)o.includes(e.key)||a.set(e.key,e.piece);return{anims:s,fadings:a}}(i,t);if(n.anims.size||n.fadings.size){let e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:n},e||function e(t,i){let r=t.animation.current;if(void 0===r){t.dom.destroyed||t.dom.redrawNow();return}let n=1-(i-r.start)*r.frequency;if(n<=0)t.animation.current=void 0,t.dom.redrawNow();else{let i=is(n);for(let e of r.plan.anims.values())e[2]=e[0]*i,e[3]=e[1]*i;t.dom.redrawNow(!0),requestAnimationFrame((i=performance.now())=>e(t,i))}}(t,performance.now())}else t.dom.redraw();return r}(e,t):it(e,t);function it(e,t){let i=e(t);return t.dom.redraw(),i}let ii=(e,t)=>({key:e,pos:P(e),piece:t}),ir=(e,t)=>t.sort((t,i)=>L(e.pos,t.pos)-L(e.pos,i.pos))[0],is=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,io=["green","red","blue","yellow"];function ia(e,t){e.drawable.current&&(e.drawable.current.pos=U(t))}function il(e){let t=e.drawable.current;t&&(t.mouseSq&&function(e,t){let i=e=>e.orig===t.orig&&e.dest===t.dest,r=e.shapes.find(i);r&&(e.shapes=e.shapes.filter(e=>!i(e))),r&&r.brush===t.brush||e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),ic(e)}(e.drawable,t),ih(e))}function ih(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function ic(e){e.onChange&&e.onChange(e.shapes)}function iu(e){requestAnimationFrame(()=>{var t;let i=e.draggable.current;if(!i)return;(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(i.orig))&&(e.animation.current=void 0);let r=e.pieces.get(i.orig);if(r&&z(r,i.piece)){if(!i.started&&L(i.pos,i.origPos)>=Math.pow(e.draggable.distance,2)&&(i.started=!0),i.started){if("function"==typeof i.element){let e=i.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),i.element=e}let t=e.dom.bounds();$(i.element,[i.pos[0]-t.left-t.width/16,i.pos[1]-t.top-t.height/16]),i.keyHasChanged||(i.keyHasChanged=i.orig!==t0(i.pos,t1(e),t))}}else im(e);iu(e)})}function id(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=U(t))}function ip(e,t){let i=e.draggable.current;if(!i)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&i.originTarget!==t.target&&!i.newPiece){e.draggable.current=void 0;return}tK(e),t$(e);let r=t0(U(t)||i.pos,t1(e),e.dom.bounds());r&&i.started&&i.orig!==r?i.newPiece?tW(e,i.orig,r,i.force):(e.stats.ctrlKey=t.ctrlKey,tF(e,i.orig,r)&&(e.stats.dragged=!0)):i.newPiece?e.pieces.delete(i.orig):e.draggable.deleteOnDropOff&&!r&&(e.pieces.delete(i.orig),tz(e.events.change)),(i.orig===i.previouslySelected||i.keyHasChanged)&&(i.orig===r||!r)?tj(e):e.selectable.enabled||tj(e),ig(e),e.draggable.current=void 0,e.dom.redraw()}function im(e){let t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,tj(e),ig(e),e.dom.redraw())}function ig(e){let t=e.dom.elements;t.ghost&&I(t.ghost,!1)}function iv(e,t){let i=e.dom.elements.board.firstChild;for(;i;){if(i.cgKey===t&&"PIECE"===i.tagName)return i;i=i.nextSibling}}function ib(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}let ik={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function iw({orig:e,dest:t,brush:i,piece:r,modifiers:n,customSvg:s,label:o},a,l,h){var c,u;return[h.width,h.height,l,e,t,i,a&&"-",r&&[r.color,r.role,r.scale].filter(e=>e).join(","),n&&[n.lineWidth,n.hilite&&"*"].filter(e=>e).join(","),s&&`custom-${iy(s.html)},${null!==(u=null===(c=s.center)||void 0===c?void 0:c[0])&&void 0!==u?u:"o"}`,o&&`label-${iy(o.text)}`].filter(e=>e).join(",")}function iy(e){let t=0;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i)>>>0;return t.toString()}function iC(e){return["#ffffff","#fff","white"].includes(e.color)?ik.hilitePrimary:ik.hiliteWhite}function ix(e,t){return"white"===t?e:[7-e[0],7-e[1]]}function iS(e,t){return!0===(e&&t.has(e)&&t.get(e).size>1)}function iE(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function i_(e,t){for(let i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.setAttribute(i,t[i]);return e}function iM(e,t){return t?{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(e=>e).join("")}:e}function iq(e,t){return(e.opacity||1)*(t?.9:1)}function iO(e,t){let i=Math.min(1,t.width/t.height),r=Math.min(1,t.height/t.width);return[(e[0]-3.5)*i,(3.5-e[1])*r]}function iA(e,t,i=!0){let r=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return i?(Math.round(8*r/Math.PI)+16)%16:r}function iP(e,t,i){let r=Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((e,t)=>e+t*t,0)),n=iA(e,t,!1);if(i&&(r-=33/64,i.size>1)){r-=10/64;let n=iA(e,t);(i.has((n+1)%16)||i.has((n+15)%16))&&1&n&&(r-=.4)}return[e[0]-Math.cos(n)*r,e[1]-Math.sin(n)*r].map(e=>e+.5)}function iR(e,t){let i;let r=W("coords",t);for(let t of e)(i=W("coord")).textContent=t,r.appendChild(i);return r}function iN(e,t,i,r){return e.addEventListener(t,i,r),()=>e.removeEventListener(t,i,r)}let iB=e=>t=>{e.draggable.current?im(e):e.drawable.current?ih(e):t.shiftKey||F(t)?e.drawable.enabled&&function(e,t){var i;if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?tj(e):tX(e);let r=U(t),n=t0(r,t1(e),e.dom.bounds());n&&(e.drawable.current={orig:n,pos:r,brush:io[((t.shiftKey||t.ctrlKey)&&F(t)?1:0)+(t.altKey||t.metaKey||(null===(i=t.getModifierState)||void 0===i?void 0:i.call(t,"AltGraph"))?2:0)],snapToValidMove:e.drawable.defaultSnapToValidMove},function e(t){requestAnimationFrame(()=>{let i=t.drawable.current;if(i){let r=t0(i.pos,t1(t),t.dom.bounds());r||(i.snapToValidMove=!1);let n=i.snapToValidMove?function(e,t,i,r){let n=P(e),s=N.filter(e=>tB(n[0],n[1],e[0],e[1])||tP(n[0],n[1],e[0],e[1])),o=s.map(e=>G(A(e),i,r)).map(e=>L(t,e)),[,a]=o.reduce((e,t,i)=>e[0]<t?e:[t,i],[o[0],0]);return A(s[a])}(i.orig,i.pos,t1(t),t.dom.bounds()):r;n!==i.mouseSq&&(i.mouseSq=n,i.dest=n!==i.orig?n:void 0,t.dom.redrawNow()),e(t)}})}(e))}(e,t):e.viewOnly||(e.dropmode.active?function(e,t){if(!e.dropmode.active)return;tK(e),t$(e);let i=e.dropmode.piece;if(i){e.pieces.set("a0",i);let r=U(t),n=r&&t0(r,t1(e),e.dom.bounds());n&&tW(e,"a0",n)}e.dom.redraw()}(e,t):function(e,t){if(!(e.trustAllEvents||t.isTrusted)||void 0!==t.buttons&&t.buttons>1||t.touches&&t.touches.length>1)return;let i=e.dom.bounds(),r=U(t),n=t0(r,t1(e),i);if(!n)return;let s=e.pieces.get(n),o=e.selected;if(!o&&e.drawable.enabled&&(e.drawable.eraseOnClick||!s||s.color!==e.turnColor)&&e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),ic(e.drawable)),!1!==t.cancelable&&(!t.touches||e.blockTouchScroll||s||o||function(e,t){let i=t1(e),r=e.dom.bounds(),n=Math.pow(r.width/8,2);for(let s of e.pieces.keys())if(L(G(s,i,r),t)<=n)return!0;return!1}(e,r)))t.preventDefault();else if(t.touches)return;let a=!!e.premovable.current,l=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&tQ(e,e.selected,n)?ie(e=>tG(e,n),e):tG(e,n);let h=e.selected===n,c=iv(e,n);if(s&&c&&h&&function(e,t){let i=e.pieces.get(t);return!!i&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===i.color&&(e.turnColor===i.color||e.premovable.enabled))}(e,n)){e.draggable.current={orig:n,piece:s,origPos:r,pos:r,started:e.draggable.autoDistance&&e.stats.dragged,element:c,previouslySelected:o,originTarget:t.target,keyHasChanged:!1},c.cgDragging=!0,c.classList.add("dragging");let a=e.dom.elements.ghost;a&&(a.className=`ghost ${s.color} ${s.role}`,$(a,K(i)(P(n),t1(e))),I(a,!0)),iu(e)}else a&&tK(e),l&&t$(e);e.dom.redraw()}(e,t))},iT=(e,t,i)=>r=>{e.drawable.current?e.drawable.enabled&&i(e,r):e.viewOnly||t(e,r)};function iL(e){var t,i;let r=e.dom.elements.wrap.getBoundingClientRect(),n=e.dom.elements.container,s=r.height/r.width,o=8*Math.floor(r.width*window.devicePixelRatio/8)/window.devicePixelRatio,a=o*s;n.style.width=o+"px",n.style.height=a+"px",e.dom.bounds.clear(),null===(t=e.addDimensionsCssVarsTo)||void 0===t||t.style.setProperty("---cg-width",o+"px"),null===(i=e.addDimensionsCssVarsTo)||void 0===i||i.style.setProperty("---cg-height",a+"px")}let iz=e=>"PIECE"===e.tagName,iK=e=>"SQUARE"===e.tagName;function i$(e,t){for(let i of t)e.dom.elements.board.removeChild(i)}function iD(e,t){let i=e[1];return`${t?10-i:3+i}`}let iI=e=>`${e.color} ${e.role}`;function iU(e,t,i){let r=e.get(t);r?e.set(t,`${r} ${i}`):e.set(t,i)}function iF(e,t,i){let r=e.get(t);r?r.push(i):e.set(t,[i])}let iW=e=>{var t,i,r;return[e.orig,null===(t=e.piece)||void 0===t?void 0:t.role,null===(i=e.piece)||void 0===i?void 0:i.color,null===(r=e.piece)||void 0===r?void 0:r.scale].join(",")};function iG(e,t,i,r,n){let s=void 0===t?void 0:t.key;return{sel:e,data:t,children:i,text:r,elm:n,key:s}}let iH=Array.isArray;function ij(e){return"string"==typeof e||"number"==typeof e||e instanceof String||e instanceof Number}function iV(e,t,i){let r,n,s,o={};if(void 0!==i?(null!==t&&(o=t),iH(i)?r=i:ij(i)?n=i.toString():i&&i.sel&&(r=[i])):null!=t&&(iH(t)?r=t:ij(t)?n=t.toString():t&&t.sel?r=[t]:o=t),void 0!==r)for(s=0;s<r.length;++s)ij(r[s])&&(r[s]=iG(void 0,void 0,void 0,r[s],void 0));return e.startsWith("svg")&&(3===e.length||"."===e[3]||"#"===e[3])&&function e(t,i,r){if(t.ns="http://www.w3.org/2000/svg","foreignObject"!==r&&void 0!==i)for(let t=0;t<i.length;++t){let r=i[t];if("string"==typeof r)continue;let n=r.data;void 0!==n&&e(n,r.children,r.sel)}}(o,r,e),iG(e,o,r,n,void 0)}let iQ=(e,t,i,r=!0)=>iY(n=>n.addEventListener(e,e=>{let r=t(e);return!1===r&&e.preventDefault(),null==i||i(),r},{passive:r}));function iY(e){return{insert:t=>e(t.elm)}}let iZ=e=>e.altKey||e.ctrlKey||e.shiftKey||e.metaKey||document.activeElement instanceof HTMLInputElement||document.activeElement instanceof HTMLTextAreaElement,iX=e=>t=>{iZ(t)||("ArrowLeft"==t.key?e.goTo("prev"):"ArrowRight"==t.key?e.goTo("next"):"f"==t.key&&e.flip())},iJ=e=>{var t,i;return iV("div.lpv__menu.lpv__pane",[iV("button.lpv__menu__entry.lpv__menu__flip.lpv__fbt",{hook:iQ("click",e.flip)},e.translate("flipTheBoard")),(null===(t=e.opts.menu.analysisBoard)||void 0===t?void 0:t.enabled)?iV("a.lpv__menu__entry.lpv__menu__analysis.lpv__fbt",{attrs:{href:e.analysisUrl(),target:"_blank"}},e.translate("analysisBoard")):void 0,(null===(i=e.opts.menu.practiceWithComputer)||void 0===i?void 0:i.enabled)?iV("a.lpv__menu__entry.lpv__menu__practice.lpv__fbt",{attrs:{href:e.practiceUrl(),target:"_blank"}},e.translate("practiceWithComputer")):void 0,e.opts.menu.getPgn.enabled?iV("button.lpv__menu__entry.lpv__menu__pgn.lpv__fbt",{hook:iQ("click",e.togglePgn)},e.translate("getPgn")):void 0,i0(e)])},i0=e=>{let t=e.game.metadata.externalLink;return t&&iV("a.lpv__menu__entry.lpv__fbt",{attrs:{href:t,target:"_blank"}},e.translate(e.game.metadata.isLichess?"viewOnLichess":"viewOnSite"))},i1=e=>iV("div.lpv__controls",["board"==e.pane?void 0:i2(e,"first","step-backward"),i2(e,"prev","left-open"),iV("button.lpv__fbt.lpv__controls__menu.lpv__icon",{class:{active:"board"!=e.pane,"lpv__icon-ellipsis-vert":"board"==e.pane},hook:iQ("click",e.toggleMenu)},"board"==e.pane?void 0:"X"),i2(e,"next","right-open"),"board"==e.pane?void 0:i2(e,"last","step-forward")]),i2=(e,t,i)=>iV(`button.lpv__controls__goto.lpv__controls__goto--${t}.lpv__fbt.lpv__icon.lpv__icon-${i}`,{class:{disabled:"board"==e.pane&&!e.canGoTo(t)},hook:iY(i=>(function(e,t,i){for(let i of["touchstart","mousedown"])e.addEventListener(i,e=>{t(e),e.preventDefault()},{passive:!1})})(i,i=>(function(e,t){let i=()=>{e(),n=setTimeout(i,r=Math.max(100,r-r/15))},r=350,n=setTimeout(i,500);e();let s="touchstart"==t.type?"touchend":"mouseup";document.addEventListener(s,()=>clearTimeout(n),{once:!0})})(()=>e.goTo(t),i)))}),i3=e=>iV("div.lpv__side",[iV("div.lpv__moves",{hook:{insert:t=>{let i=t.elm;e.path.empty()||rs(e,i),i.addEventListener("mousedown",t=>{let i=t.target.getAttribute("p");i&&e.toPath(new H(i))},{passive:!0})},postpatch:(t,i)=>{e.autoScrollRequested&&(rs(e,i.elm),e.autoScrollRequested=!1)}}},[...e.game.initial.comments.map(i4),...rt(e),...i5(e)])]),i5=e=>{let t=e.game.metadata.result;return t&&"*"!=t?[iV("comment.result",e.game.metadata.result)]:[]},i8=()=>iV("move.empty","..."),i6=e=>iV("index",`${e}.`),i4=e=>iV("comment",e),i9=()=>iV("paren.open","("),i7=()=>iV("paren.close",")"),re=e=>Math.floor((e.ply-1)/2)+1,rt=e=>{let t=rn(e),i=[],r,n=e.game.moves.children.slice(1);for("black"==e.game.initial.pos.turn&&e.game.mainline[0]&&i.push(i6(e.game.initial.pos.fullmoves),i8());r=(r||e.game.moves).children[0];){let e=r.data,s=e.ply%2==1;s&&i.push(i6(re(e))),i.push(t(e));let o=s&&(n.length||e.comments.length)&&r.children.length;o&&i.push(i8()),e.comments.forEach(e=>i.push(i4(e))),n.forEach(e=>i.push(ri(t,e))),o&&i.push(i6(re(e)),i8()),n=r.children.slice(1)}return i},ri=(e,t)=>iV("variation",[...t.data.startingComments.map(i4),...rr(e,t)]),rr=(e,t)=>{let i=[],r=[];t.data.ply%2==0&&i.push(iV("index",[re(t.data),"..."]));do{let n=t.data;n.ply%2==1&&i.push(iV("index",[re(n),"."])),i.push(e(n)),n.comments.forEach(e=>i.push(i4(e))),r.forEach(t=>{i=[...i,i9(),...rr(e,t),i7()]}),r=t.children.slice(1),t=t.children[0]}while(t);return i},rn=e=>t=>iV("move",{class:{current:e.path.equals(t.path),ancestor:e.path.contains(t.path),good:t.nags.includes(1),mistake:t.nags.includes(2),brilliant:t.nags.includes(3),blunder:t.nags.includes(4),interesting:t.nags.includes(5),inaccuracy:t.nags.includes(6)},attrs:{p:t.path.path}},t.san),rs=(e,t)=>{let i=t.querySelector(".current");if(!i){t.scrollTop=e.path.empty()?0:99999;return}t.scrollTop=i.offsetTop-t.offsetHeight/2+i.offsetHeight};function ro(e,t){let i="bottom"==t?e.orientation():p(e.orientation()),r=e.game.players[i],n=[r.title?iV("span.lpv__player__title",r.title):void 0,iV("span.lpv__player__name",r.name),r.rating?iV("span.lpv__player__rating",["(",r.rating,")"]):void 0];return iV(`div.lpv__player.lpv__player--${t}`,[r.isLichessUser?iV("a.lpv__player__person.ulpt.user-link",{attrs:{href:`${e.opts.lichess}/@/${r.name}`}},n):iV("span.lpv__player__person",n),e.opts.showClocks?ra(e,i):void 0])}let ra=(e,t)=>{let i=e.curData(),r=i.clocks&&i.clocks[t];return iV("div.lpv__player__clock",{class:{active:t==i.turn}},rl(r))},rl=e=>{if(!e&&0!==e)return["-"];let t=new Date(1e3*e),i=rh(t.getUTCMinutes())+":"+rh(t.getUTCSeconds());return e>=3600?[Math.floor(e/3600)+":"+i]:[i]},rh=e=>(e<10?"0":"")+e;function rc(e){let t=e.opts,i=`lpv.lpv--moves-${t.showMoves}.lpv--controls-${t.showControls}${t.classes?"."+t.classes.replace(" ","."):""}`,r="auto"==t.showPlayers?e.game.hasPlayerName():t.showPlayers;return iV(`div.${i}`,{class:{"lpv--menu":"board"!=e.pane,"lpv--players":r},attrs:{tabindex:0},hook:iY(t=>{e.setGround(function(e,t){let i={pieces:t8(t2),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:B()};function r(){let t;let r="dom"in i?i.dom.unbind:void 0,n=function(e,t){let i,r,n,s;for(let i of(e.innerHTML="",e.classList.add("cg-wrap"),E))e.classList.toggle("orientation-"+i,t.orientation===i);e.classList.toggle("manipulable",!t.viewOnly);let o=W("cg-container");e.appendChild(o);let a=W("cg-board");if(o.appendChild(a),t.drawable.visible&&((i=i_(iE("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"})).appendChild(function(){let e=iE("defs"),t=i_(iE("filter"),{id:"cg-filter-blur"});return t.appendChild(i_(iE("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}()),i.appendChild(iE("g")),(r=i_(iE("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"})).appendChild(iE("g")),n=W("cg-auto-pieces"),o.appendChild(i),o.appendChild(r),o.appendChild(n)),t.coordinates){let e="black"===t.orientation?" black":"",i="left"===t.ranksPosition?" left":"";if(t.coordinatesOnSquares){let r="white"===t.orientation?e=>e+1:e=>8-e;_.forEach((t,n)=>o.appendChild(iR(M.map(e=>t+e),"squares rank"+r(n)+e+i)))}else o.appendChild(iR(M,"ranks"+e+i)),o.appendChild(iR(_,"files"+e))}return t.draggable.enabled&&t.draggable.showGhost&&(I(s=W("piece","ghost"),!1),o.appendChild(s)),{board:a,container:o,wrap:e,ghost:s,svg:i,customSvg:r,autoPieces:n}}(e,i),s=function(e){let t;let i=()=>(void 0===t&&(t=e()),t);return i.clear=()=>{t=void 0},i}(()=>n.board.getBoundingClientRect()),o=e=>{if(function(e){let t,i,r,n,s,o,a,l,h,c;let u=t1(e),d=K(e.dom.bounds()),p=e.dom.elements.board,f=e.pieces,m=e.animation.current,g=m?m.plan.anims:new Map,v=m?m.plan.fadings:new Map,b=e.draggable.current,k=function(e){var t,i,r;let n=new Map;if(e.lastMove&&e.highlight.lastMove)for(let t of e.lastMove)iU(n,t,"last-move");if(e.check&&e.highlight.check&&iU(n,e.check,"check"),e.selected&&(iU(n,e.selected,"selected"),e.movable.showDests)){let s=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(s)for(let t of s)iU(n,t,"move-dest"+(e.pieces.has(t)?" oc":""));let o=null!==(r=null===(i=e.premovable.customDests)||void 0===i?void 0:i.get(e.selected))&&void 0!==r?r:e.premovable.dests;if(o)for(let t of o)iU(n,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}let s=e.premovable.current;if(s)for(let e of s)iU(n,e,"current-premove");else e.predroppable.current&&iU(n,e.predroppable.current.key,"current-premove");let o=e.exploding;if(o)for(let e of o.keys)iU(n,e,"exploding"+o.stage);return e.highlight.custom&&e.highlight.custom.forEach((e,t)=>{iU(n,t,e)}),n}(e),w=new Set,y=new Set,C=new Map,x=new Map;for(i=p.firstChild;i;){if(t=i.cgKey,iz(i)){if(r=f.get(t),s=g.get(t),o=v.get(t),n=i.cgPiece,i.cgDragging&&(!b||b.orig!==t)&&(i.classList.remove("dragging"),$(i,d(P(t),u)),i.cgDragging=!1),!o&&i.cgFading&&(i.cgFading=!1,i.classList.remove("fading")),r){if(s&&i.cgAnimating&&n===iI(r)){let e=P(t);e[0]+=s[2],e[1]+=s[3],i.classList.add("anim"),$(i,d(e,u))}else i.cgAnimating&&(i.cgAnimating=!1,i.classList.remove("anim"),$(i,d(P(t),u)),e.addPieceZIndex&&(i.style.zIndex=iD(P(t),u)));n!==iI(r)||o&&i.cgFading?o&&n===iI(o)?(i.classList.add("fading"),i.cgFading=!0):iF(C,n,i):w.add(t)}else iF(C,n,i)}else if(iK(i)){let e=i.className;k.get(t)===e?y.add(t):iF(x,e,i)}i=i.nextSibling}for(let[e,t]of k)if(!y.has(e)){c=(h=x.get(t))&&h.pop();let i=d(P(e),u);if(c)c.cgKey=e,$(c,i);else{let r=W("square",t);r.cgKey=e,$(r,i),p.insertBefore(r,p.firstChild)}}for(let[t,i]of f)if(s=g.get(t),!w.has(t)){if(l=(a=C.get(iI(i)))&&a.pop()){l.cgKey=t,l.cgFading&&(l.classList.remove("fading"),l.cgFading=!1);let i=P(t);e.addPieceZIndex&&(l.style.zIndex=iD(i,u)),s&&(l.cgAnimating=!0,l.classList.add("anim"),i[0]+=s[2],i[1]+=s[3]),$(l,d(i,u))}else{let r=iI(i),n=W("piece",r),o=P(t);n.cgPiece=r,n.cgKey=t,s&&(n.cgAnimating=!0,o[0]+=s[2],o[1]+=s[3]),$(n,d(o,u)),e.addPieceZIndex&&(n.style.zIndex=iD(o,u)),p.appendChild(n)}}for(let t of C.values())i$(e,t);for(let t of x.values())i$(e,t)}(l),n.autoPieces){var t;t=n.autoPieces,function(e,t,i){let r=new Map,n=[];for(let t of e)r.set(t.hash,!1);let s=t.firstElementChild,o;for(;s;)o=s.getAttribute("cgHash"),r.has(o)?r.set(o,!0):n.push(s),s=s.nextElementSibling;for(let e of n)t.removeChild(e);for(let n of e)r.get(n.hash)||t.appendChild(i(n))}(l.drawable.autoShapes.filter(e=>e.piece).map(e=>({shape:e,hash:iW(e),current:!1})),t,e=>(function(e,{shape:t,hash:i},r){var n,s,o;let a=t.orig,l=null===(n=t.piece)||void 0===n?void 0:n.role,h=null===(s=t.piece)||void 0===s?void 0:s.color,c=null===(o=t.piece)||void 0===o?void 0:o.scale,u=W("piece",`${l} ${h}`);return u.setAttribute("cgHash",i),u.cgKey=a,u.cgScale=c,D(u,K(r)(P(a),t1(e)),c),u})(l,e,l.dom.bounds()))}!e&&n.svg&&function(e,t,i){var r;let n=e.drawable,s=n.current,o=s&&s.mouseSq?s:void 0,a=new Map,l=e.dom.bounds(),h=n.autoShapes.filter(e=>!e.piece);for(let t of n.shapes.concat(h).concat(o?[o]:[])){if(!t.dest)continue;let i=null!==(r=a.get(t.dest))&&void 0!==r?r:new Set,n=iO(ix(P(t.orig),e.orientation),l),s=iO(ix(P(t.dest),e.orientation),l);i.add(iA(n,s)),a.set(t.dest,i)}let c=n.shapes.concat(h).map(e=>({shape:e,current:!1,hash:iw(e,iS(e.dest,a),!1,l)}));o&&c.push({shape:o,current:!0,hash:iw(o,iS(o.dest,a),!0,l)});let u=c.map(e=>e.hash).join(";");u!==e.drawable.prevSvgHash&&(e.drawable.prevSvgHash=u,function(e,t,i){var r;let n;let s=new Map;for(let i of t.filter(e=>e.shape.dest&&e.shape.brush))n=iM(e.brushes[i.shape.brush],i.shape.modifiers),(null===(r=i.shape.modifiers)||void 0===r?void 0:r.hilite)&&s.set(iC(n).key,iC(n)),s.set(n.key,n);let o=new Set,a=i.firstElementChild;for(;a;)o.add(a.getAttribute("cgKey")),a=a.nextElementSibling;for(let[e,t]of s.entries())o.has(e)||i.appendChild(function(e){let t=i_(iE("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(i_(iE("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}(t))}(n,c,t.querySelector("defs")),function(e,t,i,r){let n=new Map;for(let t of e)n.set(t.hash,!1);for(let e of[t,i]){let t=[],i=e.firstElementChild,r;for(;i;)r=i.getAttribute("cgHash"),n.has(r)?n.set(r,!0):t.push(i),i=i.nextElementSibling;for(let i of t)e.removeChild(i)}for(let s of e.filter(e=>!n.get(e.hash)))for(let e of r(s))e.isCustom?i.appendChild(e.el):t.appendChild(e.el)}(c,t.querySelector("g"),i.querySelector("g"),t=>(function(e,{shape:t,current:i,hash:r},n,s,o){var a,l;let h=iO(ix(P(t.orig),e.orientation),o),c=t.dest?iO(ix(P(t.dest),e.orientation),o):h,u=t.brush&&iM(n[t.brush],t.modifiers),d=s.get(t.dest),p=[];if(u){let e=i_(iE("g"),{cgHash:r});p.push({el:e}),h[0]!==c[0]||h[1]!==c[1]?e.appendChild(function(e,t,i,r,n,s){var o;function a(o){var a;let l=(s&&!n?20:10)/64,h=r[0]-i[0],c=Math.atan2(r[1]-i[1],h),u=Math.cos(c)*l,d=Math.sin(c)*l;return i_(iE("line"),{stroke:o?iC(t).color:t.color,"stroke-width":(t.lineWidth||10)*(n?.85:1)/64+(o?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${o?iC(t).key:t.key})`,opacity:(null===(a=e.modifiers)||void 0===a?void 0:a.hilite)?1:iq(t,n),x1:i[0],y1:i[1],x2:r[0]-u,y2:r[1]-d})}if(!(null===(o=e.modifiers)||void 0===o?void 0:o.hilite))return a(!1);let l=iE("g"),h=i_(iE("g"),{filter:"url(#cg-filter-blur)"});return h.appendChild(function(e,t){let i={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return i_(iE("rect"),{x:i.from[0],y:i.from[1],width:i.to[0]-i.from[0],height:i.to[1]-i.from[1],fill:"none",stroke:"none"})}(i,r)),h.appendChild(a(!0)),l.appendChild(h),l.appendChild(a(!1)),l}(t,u,h,c,i,iS(t.dest,s))):e.appendChild(function(e,t,i,r){let n=[3/64,4/64],s=(r.width+r.height)/(4*Math.max(r.width,r.height));return i_(iE("circle"),{stroke:e.color,"stroke-width":n[i?0:1],fill:"none",opacity:iq(e,i),cx:t[0],cy:t[1],r:s-n[1]/2})}(n[t.brush],h,i,o))}if(t.label){let e=t.label;null!==(a=e.fill)&&void 0!==a||(e.fill=t.brush&&n[t.brush].color);let i=t.brush?void 0:"tr";p.push({el:function(e,t,i,r,n,s){var o;let a=.4*.75**e.text.length,l=iP(i,r,n),h="tr"===s?.4:0,c=i_(iE("g"),{transform:`translate(${l[0]+h},${l[1]-h})`,cgHash:t});c.appendChild(i_(iE("circle"),{r:.2,"fill-opacity":s?1:.8,"stroke-opacity":s?1:.7,"stroke-width":.03,fill:null!==(o=e.fill)&&void 0!==o?o:"#666",stroke:"white"}));let u=i_(iE("text"),{"font-size":a,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return u.innerHTML=e.text,c.appendChild(u),c}(e,r,h,c,d,i),isCustom:!0})}if(t.customSvg){let e=null!==(l=t.customSvg.center)&&void 0!==l?l:"orig",[i,n]="label"===e?iP(h,c,d).map(e=>e-.5):"dest"===e?c:h,s=i_(iE("g"),{transform:`translate(${i},${n})`,cgHash:r});s.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,p.push({el:s,isCustom:!0})}return p})(e,t,n.brushes,a,l)))}(l,n.svg,n.customSvg)},a=()=>{iL(l),function(e){let t=t1(e),i=K(e.dom.bounds()),r=e.dom.elements.board.firstChild;for(;r;)(iz(r)&&!r.cgAnimating||iK(r))&&$(r,i(P(r.cgKey),t)),r=r.nextSibling}(l),n.autoPieces&&function(e){var t;let i=t1(e),r=K(e.dom.bounds()),n=null===(t=e.dom.elements.autoPieces)||void 0===t?void 0:t.firstChild;for(;n;)D(n,r(P(n.cgKey),i),n.cgScale),n=n.nextSibling}(l)},l=i;return l.dom={elements:n,bounds:s,redraw:(t=!1,()=>{t||(t=!0,requestAnimationFrame(()=>{o(),t=!1}))}),redrawNow:o,unbind:r},l.drawable.prevSvgHash="",iL(l),o(!1),function(e,t){let i=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&i.addEventListener("contextmenu",e=>e.preventDefault()),e.viewOnly)return;let r=iB(e);i.addEventListener("touchstart",r,{passive:!1}),i.addEventListener("mousedown",r,{passive:!1})}(l,a),r||(l.dom.unbind=function(e,t){let i=[];if("ResizeObserver"in window||i.push(iN(document.body,"chessground.resize",t)),!e.viewOnly){let t=iT(e,id,ia),r=iT(e,ip,il);for(let e of["touchmove","mousemove"])i.push(iN(document,e,t));for(let e of["touchend","mouseup"])i.push(iN(document,e,r));let n=()=>e.dom.bounds.clear();i.push(iN(document,"scroll",n,{capture:!0,passive:!0})),i.push(iN(window,"resize",n,{passive:!0}))}return()=>i.forEach(e=>e())}(l,a)),l.events.insert&&l.events.insert(n),l}return t4(i,t||{}),function(e,t){function i(){e.orientation=T(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0,t()}return{set(t){t.orientation&&t.orientation!==e.orientation&&i(),t6(e,t),(t.fen?ie:it)(e=>t4(e,t),e)},state:e,getFen:()=>{var t;return t=e.pieces,q.map(e=>_.map(i=>{let r=t.get(i+e);if(!r)return"1";{let e=t5[r.role];return"white"===r.color&&(e=e.toUpperCase()),r.promoted&&(e+="~"),e}}).join("")).join("/").replace(/1{2,}/g,e=>e.length.toString())},toggleOrientation:i,setPieces(t){ie(e=>(function(e,t){for(let[i,r]of t)r?e.pieces.set(i,r):e.pieces.delete(i)})(e,t),e)},selectSquare(t,i){t?ie(e=>tG(e,t,i),e):e.selected&&(tj(e),e.dom.redraw())},move(t,i){ie(e=>tD(e,t,i),e)},newPiece(t,i){ie(e=>tI(e,t,i),e)},playPremove(){if(e.premovable.current){if(ie(tZ,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){let i=function(e,t){let i=e.predroppable.current,r=!1;if(!i)return!1;if(t(i)){let t={role:i.role,color:e.movable.color};tI(e,t,i.key)&&(tz(e.movable.events.afterNewPiece,i.role,i.key,{premove:!1,predrop:!0}),r=!0)}return t$(e),r}(e,t);return e.dom.redraw(),i}return!1},cancelPremove(){it(tK,e)},cancelPredrop(){it(t$,e)},cancelMove(){it(e=>{tX(e),im(e)},e)},stop(){it(e=>{tJ(e),im(e)},e)},explode(t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{ib(e,2),setTimeout(()=>ib(e,void 0),120)},120)},setAutoShapes(t){it(e=>e.drawable.autoShapes=t,e)},setShapes(t){it(e=>e.drawable.shapes=t,e)},getKeyAtDomPos:t=>t0(t,t1(e),e.dom.bounds()),redrawAll:t,dragNewPiece(t,i,r){!function(e,t,i,r){e.pieces.set("a0",t),e.dom.redraw();let n=U(i);e.draggable.current={orig:"a0",piece:t,origPos:n,pos:n,started:!0,element:()=>iv(e,"a0"),originTarget:i.target,newPiece:!0,force:!!r,keyHasChanged:!1},iu(e)}(e,t,i,r)},destroy(){tJ(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}(r(),r)}(t.querySelector(".cg-wrap"),rp(e,t))),t.addEventListener("keydown",iX(e))})},[r?ro(e,"top"):void 0,ru(e),r?ro(e,"bottom"):void 0,t.showControls?i1(e):void 0,t.showMoves?i3(e):void 0,"menu"==e.pane?iJ(e):"pgn"==e.pane?rd(e):void 0])}let ru=e=>iV("div.lpv__board",{hook:iY(t=>{t.addEventListener("click",e.focus),!e.opts.scrollToMove||"ontouchstart"in window||t.addEventListener("wheel",function(e){let t=0;return i=>{Math.abs(t+=i.deltaY*(i.deltaMode?40:1))>=4?(e(i,!0),t=0):e(i,!1)}}((t,i)=>{t.preventDefault(),t.deltaY>0&&i?e.goTo("next",!1):t.deltaY<0&&i&&e.goTo("prev",!1)}))})},iV("div.cg-wrap")),rd=e=>{let t=new Blob([e.opts.pgn],{type:"text/plain"});return iV("div.lpv__pgn.lpv__pane",[iV("a.lpv__pgn__download.lpv__fbt",{attrs:{href:window.URL.createObjectURL(t),download:e.opts.menu.getPgn.fileName||`${e.game.title()}.pgn`}},e.translate("download")),iV("textarea.lpv__pgn__text",e.opts.pgn)])},rp=(e,t)=>({viewOnly:!e.opts.drawArrows,addDimensionsCssVarsTo:t,drawable:{enabled:e.opts.drawArrows,visible:!0},disableContextMenu:e.opts.drawArrows,...e.opts.chessground||{},movable:{free:!1},draggable:{enabled:!1},selectable:{enabled:!1},...e.cgState()});function rf(e){if(rm(e)){for(;e&&rm(e);)e=rg(e).parent;return null!=e?e:null}return e.parentNode}function rm(e){return 11===e.nodeType}function rg(e,t){var i,r,n;return null!==(i=e.parent)&&void 0!==i||(e.parent=null!=t?t:null),null!==(r=e.firstChildNode)&&void 0!==r||(e.firstChildNode=e.firstChild),null!==(n=e.lastChildNode)&&void 0!==n||(e.lastChildNode=e.lastChild),e}let rv={createElement:function(e,t){return document.createElement(e,t)},createElementNS:function(e,t,i){return document.createElementNS(e,t,i)},createTextNode:function(e){return document.createTextNode(e)},createDocumentFragment:function(){return rg(document.createDocumentFragment())},createComment:function(e){return document.createComment(e)},insertBefore:function(e,t,i){if(rm(e)){let t=e;for(;t&&rm(t);)t=rg(t).parent;e=null!=t?t:e}rm(t)&&(t=rg(t,e)),i&&rm(i)&&(i=rg(i).firstChildNode),e.insertBefore(t,i)},removeChild:function(e,t){e.removeChild(t)},appendChild:function(e,t){rm(t)&&(t=rg(t,e)),e.appendChild(t)},parentNode:rf,nextSibling:function(e){var t;if(rm(e)){let i=rg(e),r=rf(i);if(r&&i.lastChildNode){let e=Array.from(r.childNodes),n=e.indexOf(i.lastChildNode);return null!==(t=e[n+1])&&void 0!==t?t:null}return null}return e.nextSibling},tagName:function(e){return e.tagName},setTextContent:function(e,t){e.textContent=t},isElement:function(e){return 1===e.nodeType},isDocumentFragment:rm};function rb(e){return void 0===e}function rk(e){return void 0!==e}let rw=iG("",{},[],void 0,void 0);function ry(e,t){var i,r;let n=e.key===t.key,s=(null===(i=e.data)||void 0===i?void 0:i.is)===(null===(r=t.data)||void 0===r?void 0:r.is),o=e.sel===t.sel,a=!!e.sel||e.sel!==t.sel||typeof e.text==typeof t.text;return o&&n&&s&&a}let rC=["create","update","remove","destroy","pre","post"];function rx(e,t){let i,r;let n=t.elm,s=e.data.class,o=t.data.class;if((s||o)&&s!==o){for(r in o=o||{},s=s||{})s[r]&&!Object.prototype.hasOwnProperty.call(o,r)&&n.classList.remove(r);for(r in o)(i=o[r])!==s[r]&&n.classList[i?"add":"remove"](r)}}let rS={create:rx,update:rx};function rE(e,t){let i;let r=t.elm,n=e.data.attrs,s=t.data.attrs;if((n||s)&&n!==s){for(i in n=n||{},s=s||{}){let e=s[i];n[i]!==e&&(!0===e?r.setAttribute(i,""):!1===e?r.removeAttribute(i):120!==i.charCodeAt(0)?r.setAttribute(i,e):58===i.charCodeAt(3)?r.setAttributeNS("http://www.w3.org/XML/1998/namespace",i,e):58===i.charCodeAt(5)?109===i.charCodeAt(1)?r.setAttributeNS("http://www.w3.org/2000/xmlns/",i,e):r.setAttributeNS("http://www.w3.org/1999/xlink",i,e):r.setAttribute(i,e))}for(i in n)i in s||r.removeAttribute(i)}}let r_={create:rE,update:rE},rM={pgn:"*",fen:void 0,showPlayers:"auto",showClocks:!0,showMoves:"auto",showControls:!0,scrollToMove:!0,orientation:void 0,initialPly:0,chessground:{},drawArrows:!0,menu:{getPgn:{enabled:!0,fileName:void 0},practiceWithComputer:{enabled:!0},analysisBoard:{enabled:!0}},lichess:"https://lichess.org",classes:void 0};function rq(e){if("object"!=typeof e||null===e)return!1;let t=Object.getPrototypeOf(e);return t===Object.prototype||null===t}function rO(e,t){let i=function(e,t,i){let r={create:[],update:[],remove:[],destroy:[],pre:[],post:[]};for(let t of rC)for(let i of e){let e=i[t];void 0!==e&&r[t].push(e)}function n(e,t){var i,s,o;let a;let l=e.data;if(void 0!==l){let t=null===(i=l.hook)||void 0===i?void 0:i.init;rk(t)&&(t(e),l=e.data)}let h=e.children,c=e.sel;if("!"===c)rb(e.text)&&(e.text=""),e.elm=rv.createComment(e.text);else if(""===c)e.elm=rv.createTextNode(e.text);else if(void 0!==c){let i=c.indexOf("#"),o=c.indexOf(".",i),u=i>0?i:c.length,d=o>0?o:c.length,p=-1!==i||-1!==o?c.slice(0,Math.min(u,d)):c,f=e.elm=rk(l)&&rk(a=l.ns)?rv.createElementNS(a,p,l):rv.createElement(p,l);for(u<d&&f.setAttribute("id",c.slice(u+1,d)),o>0&&f.setAttribute("class",c.slice(d+1).replace(/\./g," ")),a=0;a<r.create.length;++a)r.create[a](rw,e);if(ij(e.text)&&(!iH(h)||0===h.length)&&rv.appendChild(f,rv.createTextNode(e.text)),iH(h))for(a=0;a<h.length;++a){let e=h[a];null!=e&&rv.appendChild(f,n(e,t))}let m=e.data.hook;rk(m)&&(null===(s=m.create)||void 0===s||s.call(m,rw,e),m.insert&&t.push(e))}else e.elm=rv.createTextNode(e.text);return e.elm}function s(e,t,i,r,s,o){for(;r<=s;++r){let s=i[r];null!=s&&rv.insertBefore(e,n(s,o),t)}}function o(e){var t,i;let n=e.data;if(void 0!==n){null===(i=null===(t=null==n?void 0:n.hook)||void 0===t?void 0:t.destroy)||void 0===i||i.call(t,e);for(let t=0;t<r.destroy.length;++t)r.destroy[t](e);if(void 0!==e.children)for(let t=0;t<e.children.length;++t){let i=e.children[t];null!=i&&"string"!=typeof i&&o(i)}}}function a(e,t,i,n){for(var s,l;i<=n;++i){let n,h;let c=t[i];if(null!=c){if(rk(c.sel)){o(c),n=r.remove.length+1,h=function(e,t){return function(){if(0==--t){let t=rv.parentNode(e);null!==t&&rv.removeChild(t,e)}}}(c.elm,n);for(let e=0;e<r.remove.length;++e)r.remove[e](c,h);let e=null===(l=null===(s=null==c?void 0:c.data)||void 0===s?void 0:s.hook)||void 0===l?void 0:l.remove;rk(e)?e(c,h):h()}else c.children?(o(c),a(e,c.children,0,c.children.length-1)):rv.removeChild(e,c.elm)}}}return function(e,t){var i,o;let l,h,c;let u=[];for(l=0;l<r.pre.length;++l)r.pre[l]();for((i=e,rv.isElement(i))?e=function(e){let t=e.id?"#"+e.id:"",i=e.getAttribute("class"),r=i?"."+i.split(" ").join("."):"";return iG(rv.tagName(e).toLowerCase()+t+r,{},[],void 0,e)}(e):(o=e,rv.isDocumentFragment(o)&&(e=iG(void 0,{},[],void 0,e))),ry(e,t)?function e(t,i,o){var l,h,c,u,d,p,f,m;let g=null===(l=i.data)||void 0===l?void 0:l.hook;null===(h=null==g?void 0:g.prepatch)||void 0===h||h.call(g,t,i);let v=i.elm=t.elm;if(t===i)return;if(void 0!==i.data||rk(i.text)&&i.text!==t.text){null!==(c=i.data)&&void 0!==c||(i.data={}),null!==(u=t.data)&&void 0!==u||(t.data={});for(let e=0;e<r.update.length;++e)r.update[e](t,i);null===(f=null===(p=null===(d=i.data)||void 0===d?void 0:d.hook)||void 0===p?void 0:p.update)||void 0===f||f.call(p,t,i)}let b=t.children,k=i.children;rb(i.text)?rk(b)&&rk(k)?b!==k&&function(t,i,r,o){let l,h,c,u=0,d=0,p=i.length-1,f=i[0],m=i[p],g=r.length-1,v=r[0],b=r[g];for(;u<=p&&d<=g;)null==f?f=i[++u]:null==m?m=i[--p]:null==v?v=r[++d]:null==b?b=r[--g]:ry(f,v)?(e(f,v,o),f=i[++u],v=r[++d]):ry(m,b)?(e(m,b,o),m=i[--p],b=r[--g]):ry(f,b)?(e(f,b,o),rv.insertBefore(t,f.elm,rv.nextSibling(m.elm)),f=i[++u],b=r[--g]):ry(m,v)?(e(m,v,o),rv.insertBefore(t,m.elm,f.elm),m=i[--p],v=r[++d]):(void 0===l&&(l=function(e,t,i){var r;let n={};for(let s=t;s<=i;++s){let t=null===(r=e[s])||void 0===r?void 0:r.key;void 0!==t&&(n[t]=s)}return n}(i,u,p)),rb(h=l[v.key])?(rv.insertBefore(t,n(v,o),f.elm),v=r[++d]):rb(l[b.key])?(rv.insertBefore(t,n(b,o),rv.nextSibling(m.elm)),b=r[--g]):((c=i[h]).sel!==v.sel?rv.insertBefore(t,n(v,o),f.elm):(e(c,v,o),i[h]=void 0,rv.insertBefore(t,c.elm,f.elm)),v=r[++d]));d<=g&&s(t,null==r[g+1]?null:r[g+1].elm,r,d,g,o),u<=p&&a(t,i,u,p)}(v,b,k,o):rk(k)?(rk(t.text)&&rv.setTextContent(v,""),s(v,null,k,0,k.length-1,o)):rk(b)?a(v,b,0,b.length-1):rk(t.text)&&rv.setTextContent(v,""):t.text!==i.text&&(rk(b)&&a(v,b,0,b.length-1),rv.setTextContent(v,i.text)),null===(m=null==g?void 0:g.postpatch)||void 0===m||m.call(g,t,i)}(e,t,u):(h=e.elm,c=rv.parentNode(h),n(t,u),null!==c&&(rv.insertBefore(c,t.elm,rv.nextSibling(h)),a(c,[e],0,0))),l=0;l<u.length;++l)u[l].data.hook.insert(u[l]);for(l=0;l<r.post.length;++l)r.post[l]();return t}}([rS,r_]),r=new tq(function(e,t){let i={...rM};return function e(t,i){for(let r in i)void 0!==i[r]&&(rq(t[r])&&rq(i[r])?e(t[r],i[r]):t[r]=i[r])}(i,t),i.fen&&(i.pgn=`[FEN "${i.fen}"]
${i.pgn}`),i.classes||(i.classes=e.className),i}(e,t),function(){s=i(s,rc(r))}),n=rc(r);e.innerHTML="";let s=i(e,n);return r.div=s.elm,r}}}]);